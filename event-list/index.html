<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Poster Generator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas library for converting HTML to image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- VanillaJS Datepicker for calendar input -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css">
    <script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js"></script>
    <!-- Papa Parse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Google Fonts: Inter, Playfair Display, Roboto Mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Playfair+Display:wght@400..900&family=Roboto+Mono:wght@100..700&display=swap" rel="stylesheet">
    <style>
        /* Apply a base font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* The container that will be captured */
        #poster-content {
            width: 1080px;
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        #poster-background-image {
            position: absolute;
            inset: 0;
            z-index: 0;
            background-size: cover;
            background-position: center;
            transition: filter 0.3s ease;
        }

        /* Default Story Size (1080x1920) */
        #poster-content.size-story {
            height: 1920px;
            padding: 96px;
        }
        #poster-content.size-story .event-list-container {
             flex-grow: 1;
        }

        /* Post Size (1080x1350) */
        #poster-content.size-post {
            height: 1350px;
            padding: 64px;
        }
        
        #poster-content.size-post #poster-header {
             margin-top: 24px; /* Added margin to push title down */
        }

        #poster-content.size-post .event-list-container {
            height: 874px; /* Adjusted height to compensate for reduced margin */
            flex-grow: 0;
            flex-shrink: 0;
            border-top: 2px solid rgba(255,255,255,0.15);
            border-bottom: 2px solid rgba(255,255,255,0.15);
            margin: 20px 0; /* Reduced top/bottom margin to move list up */
            padding-top: 32px;
            padding-bottom: 32px;
            padding-left: 0; /* Override Tailwind's px-4 to widen content */
            padding-right: 0; /* Override Tailwind's px-4 to widen content */
        }
         #poster-content.size-post #poster-footer-wrapper {
             margin-top: 0; /* Override default margin */
         }


        /* Styling for the scrollbar for better aesthetics and readability */
        .event-list-container::-webkit-scrollbar {
            width: 12px;
        }
        .event-list-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .event-list-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            border: 3px solid transparent;
            background-clip: content-box;
        }
        .event-list-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        /* Hide action buttons during canvas generation */
        .html2canvas-container .action-buttons {
            display: none;
        }
        
        /* Enforce light theme for datepicker */
        .datepicker {
            background-color: #fff !important;
        }
        .datepicker-picker {
            background-color: #f9fafb; /* gray-50 */
            border-radius: 1rem;
            border: 1px solid #d1d5db; /* gray-300 */
        }
        .datepicker-picker span {
             color: #111827; /* gray-900 */
        }
        .datepicker-picker .datepicker-cell:not(.disabled):hover, .datepicker-picker .datepicker-cell.focused:not(.selected) {
            background-color: #e5e7eb; /* gray-200 */
        }
        .datepicker-picker .datepicker-cell.selected, .datepicker-picker .datepicker-cell.selected:hover {
             background-color: #4f46e5; /* indigo-600 */
             color: #fff;
        }
        .datepicker-picker .datepicker-cell.today:not(.selected){
            background-color: #fff;
            border: 1px solid #4f46e5;
        }
        .datepicker-controls {
            background-color: #fff;
        }
        .datepicker-controls .btn {
            color: #374151 !important; /* gray-700 */
            font-weight: bold;
        }
        .datepicker-controls .btn:hover {
             background-color: #e5e7eb !important; /* gray-200 */
        }
        
        .action-buttons button:disabled {
            opacity: 0.2;
            cursor: not-allowed;
        }
        
        /* Style for directly editable text on the canvas */
        [contenteditable="true"] {
            cursor: text;
        }
        [contenteditable="true"]:focus {
            outline: 2px dashed rgba(139, 148, 162, 0.5); /* A soft outline for editing */
            box-shadow: 0 0 15px rgba(139, 148, 162, 0.2);
            border-radius: 8px;
        }
        
        /* Style for the status message */
        #status-message {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            opacity: 0;
            transform: translateY(20px);
        }
        #status-message.visible {
            opacity: 1;
            transform: translateY(0);
        }
        /* Custom color picker style */
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 100%;
            height: 40px;
            cursor: pointer;
            border-radius: 0.5rem;
            background-color: transparent;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 0.5rem;
        }

        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }

    </style>
</head>
<body class="bg-gray-800 text-white">

    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold tracking-tight">Social Media Event Poster Generator</h1>
            <p class="text-gray-400 mt-2 max-w-3xl mx-auto">Create your event poster by adding events and customizing the design. You can edit text directly on the preview. If your list is too long, multiple images will be generated automatically. Your work is saved in your browser.</p>
        </header>
        
        <input type="file" id="import-input" class="hidden" accept=".json,.csv">
        <input type="file" id="background-image-input" class="hidden" accept="image/*">


        <div class="flex flex-col lg:grid lg:grid-cols-3 lg:gap-8">

            <!-- Left Column: Event Details Form -->
            <div class="lg:col-span-1 bg-gray-900 p-6 rounded-2xl shadow-lg space-y-8">
                 <div>
                    <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">Event Details</h2>
                    <form id="event-form" class="space-y-4">
                        <div>
                            <label for="event-name" class="block text-sm font-medium text-gray-300">Event Name</label>
                            <input type="text" id="event-name" name="event-name" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                        </div>
                        <div>
                            <label for="event-date" class="block text-sm font-medium text-gray-300">Date</label>
                            <div class="flex items-center space-x-4 mt-1">
                                <input type="text" id="event-date" name="event-date" placeholder="Select a date" required class="block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2" autocomplete="off">
                                <div class="flex items-center">
                                    <input id="is-date-tba" name="is-date-tba" type="checkbox" class="h-4 w-4 text-yellow-500 focus:ring-yellow-400 border-gray-600 rounded bg-gray-700">
                                    <label for="is-date-tba" class="ml-2 block text-sm text-gray-300">TBA</label>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="event-location" class="block text-sm font-medium text-gray-300">Location</label>
                            <input type="text" id="event-location" name="event-location" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                        </div>
                         <div>
                            <label for="event-social" class="block text-sm font-medium text-gray-300">Social Media Handle</label>
                            <input type="text" id="event-social" name="event-social" placeholder="@username" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                        </div>
                        <div>
                            <label for="event-price" class="block text-sm font-medium text-gray-300">Ticket Price (IDR)</label>
                            <div class="flex items-center space-x-4 mt-1">
                                <input type="number" id="event-price" name="event-price" placeholder="50000" class="block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                                 <div class="flex items-center">
                                    <input id="is-free" name="is-free" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-600 rounded bg-gray-700">
                                    <label for="is-free" class="ml-2 block text-sm text-gray-300">Free</label>
                                </div>
                                 <div class="flex items-center">
                                    <input id="is-tba" name="is-tba" type="checkbox" class="h-4 w-4 text-yellow-500 focus:ring-yellow-400 border-gray-600 rounded bg-gray-700">
                                    <label for="is-tba" class="ml-2 block text-sm text-gray-300">TBA</label>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-md">
                            Add Event to List
                        </button>
                    </form>
                </div>
                 <!-- Data Source Controls -->
                <div>
                     <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">Data Management</h2>
                     <div class="space-y-4">
                        <div>
                            <label for="g-sheet-url" class="block text-sm font-medium text-gray-300">Google Sheet URL</label>
                            <input type="url" id="g-sheet-url" placeholder="https://docs.google.com/..." class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-white p-2">
                            <button id="fetch-g-sheet" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-md flex items-center justify-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M15.55 5.55a8 8 0 10-11.1 11.1 8 8 0 0011.1-11.1zM10 16a6 6 0 100-12 6 6 0 000 12zm-1-9a1 1 0 112 0v2.586l1.707 1.707a1 1 0 01-1.414 1.414L9 11.414V7z" clip-rule="evenodd" />
                                </svg>
                                <span>Fetch Live Data</span>
                            </button>
                        </div>

                         <button id="sort-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-md flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                             <span>Sort Events by Date</span>
                        </button>

                        <div class="flex items-center justify-center pt-2">
                           <input id="export-with-image" name="export-with-image" type="checkbox" class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-600 rounded bg-gray-700" checked>
                           <label for="export-with-image" class="ml-2 block text-sm text-gray-300">Include Background Image in Export</label>
                        </div>
                         <button id="export-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-md flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                             <span>Export Data</span>
                        </button>
                          <button id="import-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-md flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l4 4m0 0l-4 4m4-4H4" /></svg>
                             <span>Import Data</span>
                        </button>
                         <button id="clear-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-md flex items-center justify-center space-x-2">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                             <span>Clear All Events</span>
                        </button>
                    </div>
                </div>

                <!-- Download Controls -->
                <div class="mt-8">
                     <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">Download</h2>
                     <button id="download-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-md flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        <span>Generate & Download Image</span>
                    </button>
                    <div id="loading-indicator" class="hidden text-center mt-4 text-yellow-400">Generating image... please wait.</div>
                </div>
            </div>

            <!-- Middle Column: Poster Preview -->
            <div class="lg:col-span-1 flex-1 flex flex-col items-center">
                <h2 class="text-2xl font-bold mb-4 text-center">Poster Preview</h2>
                <!-- Container for the scaled preview. It sets the size and clips. -->
                <div id="preview-wrapper" class="w-full max-w-[360px] md:max-w-[450px] shadow-2xl rounded-xl overflow-hidden bg-gray-900">
                    <!-- This div is scaled by JavaScript to fit the container above -->
                    <div id="poster-scaler" class="origin-top-left">
                        <!-- The actual poster content that will be rendered -->
                        <div id="poster-content" class="text-white">
                            <div id="poster-background-image"></div>
                            <div id="poster-background-overlay" class="absolute inset-0 z-10"></div>
                            <header id="poster-header" class="text-center relative z-20 flex-shrink-0">
                                <h1 id="preview-title" class="font-black tracking-tighter uppercase" contenteditable="true" data-setting="title"></h1>
                                <p id="preview-subtitle" class="text-5xl text-gray-400 mt-2" contenteditable="true" data-setting="subtitle"></p>
                            </header>
                            <!-- Using class instead of ID for safer cloning -->
                            <main class="event-list-container overflow-y-auto py-8 px-4 relative z-20">
                                <!-- Events will be dynamically inserted here -->
                            </main>
                            <div id="poster-footer-wrapper" class="mt-auto pt-4 relative z-20 flex-shrink-0">
                                <p id="preview-timestamp" class="text-center text-gray-500 text-xl mb-2"></p>
                                <footer id="preview-footer" class="text-center text-gray-500 text-2xl" contenteditable="true" data-setting="footer"></footer>
                                <p id="preview-url" class="text-center text-gray-600 text-lg mt-1"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Other Controls -->
            <div class="lg:col-span-1 bg-gray-900 p-6 rounded-2xl shadow-lg space-y-8">
                 <div>
                    <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">Poster Customization</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="poster-size" class="block text-sm font-medium text-gray-300">Poster Size</label>
                            <select id="poster-size" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                                <option value="1080x1920">1080 x 1920 (Story)</option>
                                <option value="1080x1350">1080 x 1350 (Post 4:5)</option>
                            </select>
                        </div>
                        <div>
                            <label for="poster-title" class="block text-sm font-medium text-gray-300">Title Text</label>
                            <input type="text" id="poster-title" name="poster-title" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                        </div>
                        <div>
                            <label for="poster-subtitle" class="block text-sm font-medium text-gray-300">Subtitle Text</label>
                            <input type="text" id="poster-subtitle" name="poster-subtitle" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                        </div>
                        <div>
                            <label for="poster-background" class="block text-sm font-medium text-gray-300">Background Type</label>
                            <select id="poster-background" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                                <option value="deep-space">Deep Space (Default)</option>
                                <option value="sunset">Sunset</option>
                                <option value="oceanic">Oceanic</option>
                                <option value="minty">Minty</option>
                                <option value="royal">Royal</option>
                                <option value="gotham">Gotham</option>
                                <option value="custom-gradient">Custom Gradient</option>
                                <option value="image">Image</option>
                            </select>
                        </div>
                        <div id="custom-gradient-controls" class="hidden space-y-2 border-t border-gray-700 pt-4">
                            <div class="flex items-center gap-4">
                                <label for="gradient-start-color" class="text-sm font-medium text-gray-300">Start</label>
                                <input type="color" id="gradient-start-color" value="#1f2937">
                            </div>
                            <div class="flex items-center gap-4">
                                <label for="gradient-end-color" class="text-sm font-medium text-gray-300">End</label>
                                 <input type="color" id="gradient-end-color" value="#111827">
                            </div>
                        </div>
                         <!-- Image Background Controls -->
                        <div id="image-background-controls" class="hidden space-y-4 border-t border-gray-700 pt-4">
                            <div class="grid grid-cols-2 gap-2">
                                <button id="upload-image-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">Upload Image</button>
                                <button id="remove-image-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">Remove Image</button>
                            </div>
                             <div class="flex items-center justify-between mt-1">
                                <label for="background-blur-input" class="block text-sm font-medium text-gray-300">Blur</label>
                                <div class="relative flex items-center">
                                    <button id="background-blur-down" class="px-2 py-0.5 bg-gray-600 hover:bg-gray-500 rounded-l-md">-</button>
                                    <input type="number" id="background-blur-input" class="w-20 text-center bg-gray-700 border-y-0 border-x border-gray-600" min="0" max="50" step="1">
                                    <button id="background-blur-up" class="px-2 py-0.5 bg-gray-600 hover:bg-gray-500 rounded-r-md">+</button>
                                </div>
                            </div>
                             <div class="flex items-center justify-between">
                                <label for="overlay-color" class="block text-sm font-medium text-gray-300">Overlay Color</label>
                                <input type="color" id="overlay-color" value="#000000" class="w-2/5">
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="block text-sm font-medium text-gray-300">Overlay Opacity (%)</label>
                                <div class="relative flex items-center">
                                    <button id="overlay-opacity-down" class="px-2 py-0.5 bg-gray-600 hover:bg-gray-500 rounded-l-md">-</button>
                                    <input type="number" id="overlay-opacity-input" class="w-20 text-center bg-gray-700 border-y-0 border-x border-gray-600" min="0" max="100" step="1">
                                    <button id="overlay-opacity-up" class="px-2 py-0.5 bg-gray-600 hover:bg-gray-500 rounded-r-md">+</button>
                                </div>
                            </div>
                        </div>
                         <div>
                            <label for="poster-footer" class="block text-sm font-medium text-gray-300">Footer Text</label>
                            <input type="text" id="poster-footer" name="poster-footer" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                        </div>
                         <div>
                            <label for="events-per-page" class="block text-sm font-medium text-gray-300">Events Per Image</label>
                            <input type="number" id="events-per-page" name="events-per-page" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                            <p id="events-per-page-recommendation" class="text-xs text-gray-500 mt-1"></p>
                        </div>
                        <div class="flex items-center">
                            <input id="show-timestamp" name="show-timestamp" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-600 rounded bg-gray-700">
                            <label for="show-timestamp" class="ml-2 block text-sm text-gray-300">Show Generation Timestamp</label>
                        </div>
                         <div class="flex items-center">
                            <input id="show-url" name="show-url" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-600 rounded bg-gray-700">
                            <label for="show-url" class="ml-2 block text-sm text-gray-300">Show Page URL</label>
                        </div>
                    </div>
                 </div>

                 <!-- Experimental Features -->
                <div>
                    <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">Experimental Features</h2>
                    <div class="space-y-4">
                        <div class="flex items-center">
                           <input id="auto-paginate" name="auto-paginate" type="checkbox" class="h-4 w-4 text-yellow-500 focus:ring-yellow-400 border-gray-600 rounded bg-gray-700">
                           <label for="auto-paginate" class="ml-2 block text-sm text-gray-300">Auto-fit Events Per Page</label>
                        </div>
                         <div class="flex items-center">
                           <input id="auto-shorten-location" name="auto-shorten-location" type="checkbox" class="h-4 w-4 text-yellow-500 focus:ring-yellow-400 border-gray-600 rounded bg-gray-700">
                           <label for="auto-shorten-location" class="ml-2 block text-sm text-gray-300">Auto-shorten Location Text</label>
                        </div>
                    </div>
                </div>

                 <!-- Text Customization Section -->
                 <div>
                    <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">Text Customization</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="text-style-category" class="block text-sm font-medium text-gray-300">Edit Text Style For</label>
                            <select id="text-style-category" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2"></select>
                        </div>

                        <div id="text-style-controls" class="space-y-4 border-t border-gray-700 pt-4">
                            <!-- Font Family -->
                            <div>
                                <label for="font-family" class="block text-sm font-medium text-gray-300">Font Family</label>
                                <select id="font-family" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2"></select>
                            </div>
                            <!-- Color -->
                             <div class="flex items-center justify-between">
                                <label for="text-color" class="block text-sm font-medium text-gray-300">Color</label>
                                <input type="color" id="text-color" class="w-2/5">
                            </div>
                            <!-- Font Size & Weight -->
                             <div class="flex items-center justify-between">
                                <label for="font-size-input" class="block text-sm font-medium text-gray-300">Size</label>
                                <div class="relative flex items-center">
                                     <button id="font-size-down" class="px-2 py-0.5 bg-gray-600 hover:bg-gray-500 rounded-l-md">-</button>
                                     <input type="number" id="font-size-input" class="w-20 text-center bg-gray-700 border-y-0 border-x border-gray-600" min="1">
                                     <button id="font-size-up" class="px-2 py-0.5 bg-gray-600 hover:bg-gray-500 rounded-r-md">+</button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="font-weight-input" class="block text-sm font-medium text-gray-300">Weight</label>
                                 <div class="relative flex items-center">
                                     <button id="font-weight-down" class="px-2 py-0.5 bg-gray-600 hover:bg-gray-500 rounded-l-md">-</button>
                                     <input type="number" id="font-weight-input" class="w-20 text-center bg-gray-700 border-y-0 border-x border-gray-600" min="100" max="900" step="100">
                                     <button id="font-weight-up" class="px-2 py-0.5 bg-gray-600 hover:bg-gray-500 rounded-r-md">+</button>
                                </div>
                            </div>
                            <!-- Text Stroke -->
                            <div class="flex items-center justify-between">
                                <label class="block text-sm font-medium text-gray-300">Outline</label>
                                <div class="flex items-center gap-2">
                                     <input type="color" id="stroke-color" class="w-24">
                                    <div class="relative flex items-center">
                                         <button id="stroke-width-down" class="px-2 py-0.5 bg-gray-600 hover:bg-gray-500 rounded-l-md">-</button>
                                         <input type="number" id="stroke-width-input" class="w-16 text-center bg-gray-700 border-y-0 border-x border-gray-600" min="0" max="10" step="0.1">
                                         <button id="stroke-width-up" class="px-2 py-0.5 bg-gray-600 hover:bg-gray-500 rounded-r-md">+</button>
                                    </div>
                                </div>
                            </div>
                             <!-- Text Shadow -->
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <label class="text-sm font-medium text-gray-300">Shadow Color</label>
                                    <div class="w-2/5">
                                        <input type="color" id="shadow-color">
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <label for="shadow-blur-input" class="text-sm text-gray-400">Blur:</label>
                                    <div class="relative flex items-center">
                                        <button id="shadow-blur-down" class="px-2 py-0.5 bg-gray-600 hover:bg-gray-500 rounded-l-md">-</button>
                                        <input type="number" id="shadow-blur-input" class="w-16 text-center bg-gray-700 border-y-0 border-x border-gray-600" min="0" max="50" step="1">
                                        <button id="shadow-blur-up" class="px-2 py-0.5 bg-gray-600 hover:bg-gray-500 rounded-r-md">+</button>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <label for="shadow-offset-x-input" class="text-sm text-gray-400">X Offset:</label>
                                    <div class="relative flex items-center">
                                        <button id="shadow-offset-x-down" class="px-2 py-0.5 bg-gray-600 hover:bg-gray-500 rounded-l-md">-</button>
                                        <input type="number" id="shadow-offset-x-input" class="w-16 text-center bg-gray-700 border-y-0 border-x border-gray-600" min="-50" max="50" step="1">
                                        <button id="shadow-offset-x-up" class="px-2 py-0.5 bg-gray-600 hover:bg-gray-500 rounded-r-md">+</button>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                     <label for="shadow-offset-y-input" class="text-sm text-gray-400">Y Offset:</label>
                                     <div class="relative flex items-center">
                                        <button id="shadow-offset-y-down" class="px-2 py-0.5 bg-gray-600 hover:bg-gray-500 rounded-l-md">-</button>
                                        <input type="number" id="shadow-offset-y-input" class="w-16 text-center bg-gray-700 border-y-0 border-x border-gray-600" min="-50" max="50" step="1">
                                        <button id="shadow-offset-y-up" class="px-2 py-0.5 bg-gray-600 hover:bg-gray-500 rounded-r-md">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
                 
                 <!-- Status Message Area -->
                <div id="status-container" class="mt-4 h-8">
                     <div id="status-message" class="text-center text-green-400 font-semibold"></div>
                </div>
            </div>

        </div>
    </div>
    
    <!-- Custom Modal -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center p-4 transition-opacity duration-300">
        <div class="bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-md text-center transform scale-95 transition-transform duration-300">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Modal Title</h3>
            <p id="modal-message" class="text-gray-300 mb-6">Modal message goes here.</p>
            <div id="modal-buttons" class="flex justify-center space-x-4">
                <!-- Buttons will be injected here by JS -->
            </div>
        </div>
    </div>


    <script>
    // --- IIFE Wrapper to encapsulate the entire script ---
    (function() {
        // --- CONFIGURATION CONSTANTS ---
        const CONFIG = {
            DB_NAME: 'PosterGeneratorDB',
            DB_VERSION: 1,
            STORE_NAME: 'userState',
            DEBOUNCE_DELAY: 300,
            STATUS_MESSAGE_DURATION: 2000,
        };

        // --- IndexedDB Helper ---
        const dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open(CONFIG.DB_NAME, CONFIG.DB_VERSION);
            request.onerror = () => reject("Error opening IndexedDB.");
            request.onsuccess = () => resolve(request.result);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(CONFIG.STORE_NAME)) {
                    db.createObjectStore(CONFIG.STORE_NAME);
                }
            };
        });

        const idb = {
            get: (key) => dbPromise.then(db => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(CONFIG.STORE_NAME, 'readonly');
                    const store = transaction.objectStore(CONFIG.STORE_NAME);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }),
            set: (key, value) => dbPromise.then(db => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(CONFIG.STORE_NAME, 'readwrite');
                    const store = transaction.objectStore(CONFIG.STORE_NAME);
                    const request = store.put(value, key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }),
        };


        // --- DOM REFERENCES ---
        const getEl = (id) => document.getElementById(id);
        
        // Form & Controls
        const eventForm = getEl('event-form');
        const eventNameInput = getEl('event-name');
        const eventDateInput = getEl('event-date');
        const isDateTbaCheckbox = getEl('is-date-tba');
        const eventLocationInput = getEl('event-location');
        const eventSocialInput = getEl('event-social');
        const eventPriceInput = getEl('event-price');
        const isFreeCheckbox = getEl('is-free');
        const isTbaCheckbox = getEl('is-tba');
        const posterSizeSelect = getEl('poster-size');
        const posterTitleInput = getEl('poster-title');
        const posterSubtitleInput = getEl('poster-subtitle');
        const posterBackgroundSelect = getEl('poster-background');
        const posterFooterInput = getEl('poster-footer');
        const eventsPerPageInput = getEl('events-per-page');
        const showTimestampCheckbox = getEl('show-timestamp');
        const showUrlCheckbox = getEl('show-url');
        const eventsPerPageRecommendation = getEl('events-per-page-recommendation');
        const customGradientControls = getEl('custom-gradient-controls');
        const gradientStartColorInput = getEl('gradient-start-color');
        const gradientEndColorInput = getEl('gradient-end-color');
        
        // Buttons & Indicators
        const downloadBtn = getEl('download-btn');
        const clearBtn = getEl('clear-btn');
        const sortBtn = getEl('sort-btn');
        const exportBtn = getEl('export-btn');
        const exportWithImageCheckbox = getEl('export-with-image');
        const importBtn = getEl('import-btn');
        const importInput = getEl('import-input');
        const backgroundImageInput = getEl('background-image-input');
        const uploadImageBtn = getEl('upload-image-btn');
        const removeImageBtn = getEl('remove-image-btn');
        const loadingIndicator = getEl('loading-indicator');
        const statusMessage = getEl('status-message');
        const gSheetUrlInput = getEl('g-sheet-url');
        const fetchGSheetBtn = getEl('fetch-g-sheet');

        // Preview Area
        const posterContent = getEl('poster-content');
        const posterBackgroundImage = getEl('poster-background-image');
        const posterBackgroundOverlay = getEl('poster-background-overlay');
        const previewTitle = getEl('preview-title');
        const previewSubtitle = getEl('preview-subtitle');
        const previewListContainer = document.querySelector('#poster-content .event-list-container');
        const previewTimestamp = getEl('preview-timestamp');
        const previewFooter = getEl('preview-footer');
        const previewUrl = getEl('preview-url');

        // Modal
        const modal = getEl('custom-modal');
        const modalTitle = getEl('modal-title');
        const modalMessage = getEl('modal-message');
        const modalButtons = getEl('modal-buttons');
        
        // Text Style Controls
        const textStyleCategorySelect = getEl('text-style-category');
        const fontFamilySelect = getEl('font-family');
        const textColorInput = getEl('text-color');
        
        // Image Background Controls
        const imageBackgroundControls = getEl('image-background-controls');
        const overlayColorInput = getEl('overlay-color');

        // Experimental Features
        const autoPaginateCheckbox = getEl('auto-paginate');
        const autoShortenLocationCheckbox = getEl('auto-shorten-location');

        let datepickerInstance;
        let currentImageObjectUrl = null;

        // --- DATA STATE ---
        let events = [
            { "name": "Nihon no Matsuri 16", "date": "21/06/2025", "location": "Telkom University, Bojongsoang, Bandung", "socialMedia": "@nihonnomatsuri", "priceText": "Rp 25.000", "isFree": false },
            { "name": "Bunka no Hi", "date": "28/06/2025", "location": "Cihampelas Walk, Bandung", "socialMedia": "@bunkanohi_", "priceText": "Free", "isFree": true },
            { "name": "Bandung Lautan Creator Day 2", "date": "29/06/2025", "location": "Selah Hall, Bandung", "socialMedia": "@kyuufest / @bandunglautan.creator", "priceText": "Rp 15.000", "isFree": false },
            { "name": "Genshiken ITB", "date": "05/07/2025", "location": "Aula Timur ITB", "socialMedia": "@genshikenitb", "priceText": "TBA", "isFree": false },
            { "name": "Q-Anifest 2025", "date": "20/07/2025", "location": "Hotel Harris Festival City Link", "socialMedia": "@qtakasievent", "priceText": "Rp 50.000", "isFree": false },
            { "name": "Festival Axia: KomyuDoujin", "date": "TBA", "location": "TBA", "socialMedia": "@festival.axia", "priceText": "TBA", "isFree": false }
        ];
        
        const createDefaultStyle = (overrides = {}) => ({
            fontFamily: "'Inter', sans-serif",
            fontSize: 32,
            fontWeight: 400,
            color: '#E5E7EB', // gray-200
            strokeColor: '#000000',
            strokeWidth: 0,
            shadowColor: '#000000',
            shadowBlur: 0,
            shadowOffsetX: 0,
            shadowOffsetY: 0,
            ...overrides,
        });

        const defaultTextStyles = {
            title: createDefaultStyle({ fontSize: 82, fontWeight: 900, color: '#FFFFFF' }),
            subtitle: createDefaultStyle({ fontSize: 52, fontWeight: 500, color: '#9CA3AF' }),
            eventName: createDefaultStyle({ fontSize: 52, fontWeight: 700, color: '#FFFFFF' }),
            eventDetails: createDefaultStyle({ fontSize: 32, fontWeight: 400, color: '#D1D5DB' }),
            price: createDefaultStyle({ fontSize: 40, fontWeight: 700, color: '#67E8F9' }), // cyan-300
            priceFree: createDefaultStyle({ fontSize: 40, fontWeight: 700, color: '#6EE7B7' }), // green-300
            priceTba: createDefaultStyle({ fontSize: 40, fontWeight: 700, color: '#FCD34D' }), // yellow-300
            footer: createDefaultStyle({ fontSize: 24, fontWeight: 400, color: '#6B7280' }),
            timestamp: createDefaultStyle({ fontSize: 20, fontWeight: 400, color: '#6B7280' }),
            url: createDefaultStyle({ fontSize: 18, fontWeight: 400, color: '#4B5563' }),
        };

        let settings = {
            "title": "UPCOMING EVENT",
            "subtitle": "List on Bandung",
            "background": "deep-space",
            "footer": "Made by Wibu_Baleendah",
            "eventsPerPage": 9,
            "autoPaginate": false,
            "autoShortenLocation": false,
            "showTimestamp": true,
            "showUrl": false,
            "posterSize": "1080x1920",
            "gSheetUrl": "",
            "customGradient": { "start": "#1f2937", "end": "#111827" },
            "backgroundImage": null,
            "backgroundBlur": 0,
            "overlayColor": "#000000",
            "overlayOpacity": 0.5,
            "textStyles": JSON.parse(JSON.stringify(defaultTextStyles)) // Deep copy
        };
        
        const textStyleCategories = {
             title: { label: 'Title', elements: () => [previewTitle] },
             subtitle: { label: 'Subtitle', elements: () => [previewSubtitle] },
             eventName: { label: 'Event Name', elements: () => document.querySelectorAll('.event-item-name') },
             eventDetails: { label: 'Event Details (Date, Loc)', elements: () => document.querySelectorAll('.event-item-details-text') },
             price: { label: 'Ticket Price (Default)', elements: () => document.querySelectorAll('.event-item-price[data-price-type="default"]') },
             priceFree: { label: 'Ticket Price (Free)', elements: () => document.querySelectorAll('.event-item-price[data-price-type="free"]') },
             priceTba: { label: 'Ticket Price (TBA)', elements: () => document.querySelectorAll('.event-item-price[data-price-type="tba"]') },
             footer: { label: 'Footer', elements: () => [previewFooter] },
             timestamp: { label: 'Timestamp', elements: () => [previewTimestamp] },
             url: { label: 'URL', elements: () => [previewUrl] },
        };
        
        const availableFonts = {
            "'Inter', sans-serif": "Inter",
            "'Playfair Display', serif": "Playfair Display",
            "'Roboto Mono', monospace": "Roboto Mono"
        };

        const gradients = {
            'deep-space': 'linear-gradient(to bottom right, #1f2937, #111827)',
            'sunset': 'linear-gradient(to bottom right, #7b2cbf, #f97316)',
            'oceanic': 'linear-gradient(to bottom right, #0369a1, #10b981)',
            'minty': 'linear-gradient(to bottom right, #6ee7b7, #3b82f6)',
            'royal': 'linear-gradient(to bottom right, #7e22ce, #db2777)',
            'gotham': 'linear-gradient(to bottom right, #404040, #0a0a0a)'
        };
        
        // --- UTILITY FUNCTIONS ---
        function debounce(func, delay = CONFIG.DEBOUNCE_DELAY) {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        let statusTimeout;
        function showStatusMessage(message, isError = false) {
            clearTimeout(statusTimeout);
            statusMessage.textContent = message;
            statusMessage.style.color = isError ? '#f87171' : '#4ade80'; // red-400 or green-400
            statusMessage.classList.add('visible');
            statusTimeout = setTimeout(() => {
                statusMessage.classList.remove('visible');
            }, CONFIG.STATUS_MESSAGE_DURATION);
        }

        // --- MODAL FUNCTIONS ---
        function showAlert(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = `<button id="modal-ok" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-indigo-500">OK</button>`;
            modal.classList.remove('hidden');
            setTimeout(() => modal.firstElementChild.classList.remove('scale-95'), 10);
            getEl('modal-ok').onclick = () => {
                 modal.firstElementChild.classList.add('scale-95');
                 setTimeout(() => modal.classList.add('hidden'), 300);
            };
        }

        function showConfirm(title, message, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = `
                <button id="modal-cancel" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-gray-500">Cancel</button>
                <button id="modal-confirm" class="px-6 py-2 bg-red-600 hover:bg-red-700 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-red-500">Confirm</button>
            `;
            modal.classList.remove('hidden');
            setTimeout(() => modal.firstElementChild.classList.remove('scale-95'), 10);
            const hideModal = () => {
                modal.firstElementChild.classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
            getEl('modal-cancel').onclick = hideModal;
            getEl('modal-confirm').onclick = () => {
                hideModal();
                onConfirm();
            };
        }
        
        // --- DATA PERSISTENCE (using IndexedDB) ---
        async function saveState() {
            try {
                await idb.set('appState', { events, settings });
                showStatusMessage('Changes saved!');
            } catch (error) {
                console.error("Error saving state to IndexedDB:", error);
                showAlert("Save Error", "Could not save your changes. Please try again.");
            }
        };
        const debouncedSaveState = debounce(saveState, 500);

        async function loadState() {
            try {
                const loadedState = await idb.get('appState');
                if (loadedState && loadedState.events && loadedState.settings) {
                    events = loadedState.events;
                    const loadedSettings = loadedState.settings;
                    
                    settings = { ...settings, ...loadedSettings };

                    if (!settings.textStyles) settings.textStyles = JSON.parse(JSON.stringify(defaultTextStyles));
                    if (!settings.customGradient) settings.customGradient = { start: "#1f2937", end: "#111827" };

                    // Handle loading image Blob
                    if (settings.backgroundImage instanceof Blob) {
                        if (currentImageObjectUrl) {
                            URL.revokeObjectURL(currentImageObjectUrl);
                        }
                        currentImageObjectUrl = URL.createObjectURL(settings.backgroundImage);
                    }
                }
            } catch (error) {
                console.error("Could not load state from IndexedDB:", error);
                // Fallback to default state if loading fails
            }
        };
        
        // --- DYNAMIC PREVIEW SIZING ---
        function updatePreviewSize() {
            const previewWrapper = getEl('preview-wrapper');
            const posterScaler = getEl('poster-scaler');
            if (!previewWrapper || !posterScaler) return;
            const [width, height] = settings.posterSize.split('x').map(Number);
            previewWrapper.style.aspectRatio = `${width} / ${height}`;
            const containerWidth = previewWrapper.offsetWidth;
            const scale = containerWidth / width;
            posterScaler.style.transform = `scale(${scale})`;
        }


        // --- RENDERING & STYLING FUNCTIONS ---
        function applyStylesToElement(element, styleObject) {
            if (!element || !styleObject) return;
            element.style.fontFamily = styleObject.fontFamily;
            element.style.fontSize = `${styleObject.fontSize}px`;
            element.style.fontWeight = styleObject.fontWeight;
            element.style.color = styleObject.color;
            element.style.webkitTextStroke = `${styleObject.strokeWidth}px ${styleObject.strokeColor}`;
            element.style.textShadow = `${styleObject.shadowOffsetX}px ${styleObject.shadowOffsetY}px ${styleObject.shadowBlur}px ${styleObject.shadowColor}`;
        }
        
        function updateAllTextStyles() {
            Object.keys(textStyleCategories).forEach(key => {
                const category = textStyleCategories[key];
                const elements = category.elements();
                const styles = settings.textStyles[key];
                elements.forEach(el => applyStylesToElement(el, styles));
            });
        }

        const createEventElement = (event, index, showActionButtons) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex items-center gap-4';

            const eventElement = document.createElement('div');
            eventElement.className = 'event-item py-4 border-b border-white/20 flex-grow';
            
            let priceStyleKey = 'price';
            let priceType = 'default';
            if (event.isFree) {
                priceStyleKey = 'priceFree';
                priceType = 'free';
            } else if ((event.priceText || '').toUpperCase() === 'TBA') {
                priceStyleKey = 'priceTba';
                priceType = 'tba';
            }
            
            let locationText = event.location;
            if(settings.autoShortenLocation && locationText.length > 40) {
                 locationText = locationText.substring(0, 37) + '...';
            }

            const actionButtonsHtml = showActionButtons 
                ? `
                <div class="action-buttons flex flex-col gap-2 z-30">
                    <button data-action="remove" data-index="${index}" title="Remove Event" class="text-gray-400 hover:text-red-500 transition-colors">
                        <svg class="w-8 h-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                ` : '';
            
            eventElement.innerHTML = `
                <div class="flex justify-between items-start gap-4">
                    <h3 class="event-item-name break-words min-w-0" contenteditable="true" data-index="${index}" data-field="name">${event.name}</h3>
                    <p class="event-item-price flex-shrink-0 pl-4" data-price-type="${priceType}" contenteditable="true" data-index="${index}" data-field="priceText">${event.priceText}</p>
                </div>
                <div class="mt-4">
                    <div class="flex flex-wrap items-center gap-x-4">
                        <span class="event-item-details-text" contenteditable="true" data-index="${index}" data-field="date">${event.date}</span>
                        <span class="event-item-details-text text-gray-500">|</span>
                        <span class="event-item-details-text" contenteditable="true" data-index="${index}" data-field="location" data-original-location="${event.location}">${locationText}</span>
                        ${event.socialMedia ? `<span class="event-item-details-text text-gray-500">|</span><span class="event-item-details-text" contenteditable="true" data-index="${index}" data-field="socialMedia">${event.socialMedia}</span>` : ''}
                    </div>
                </div>
            `;
            
            // Apply styles after innerHTML is set
            applyStylesToElement(eventElement.querySelector('.event-item-name'), settings.textStyles.eventName);
            eventElement.querySelectorAll('.event-item-details-text').forEach(el => applyStylesToElement(el, settings.textStyles.eventDetails));
            applyStylesToElement(eventElement.querySelector('.event-item-price'), settings.textStyles[priceStyleKey]);
            

            wrapper.appendChild(eventElement);
            if(showActionButtons) {
                 const buttonsDiv = document.createElement('div');
                 buttonsDiv.innerHTML = actionButtonsHtml;
                 wrapper.appendChild(buttonsDiv);
            }

            return wrapper;
        };

        const renderEventsInPreview = () => {
            previewListContainer.innerHTML = '';
            
            if (events.length === 0) {
                previewListContainer.innerHTML = `<div class="p-8 text-center text-gray-500"><h3 class="text-4xl font-bold">No events yet.</h3><p class="text-3xl mt-2">Use the form to add one!</p></div>`;
                return;
            }
            events.forEach((event, index) => {
                const eventElement = createEventElement(event, index, true);
                previewListContainer.appendChild(eventElement);
            });
            updateAllTextStyles(); // Re-apply styles to headers/footers which are not in the loop
        };

        function updateFormControls() {
            posterSizeSelect.value = settings.posterSize;
            posterTitleInput.value = settings.title;
            posterSubtitleInput.value = settings.subtitle;
            posterBackgroundSelect.value = settings.background;
            posterFooterInput.value = settings.footer;
            eventsPerPageInput.value = settings.eventsPerPage;
            eventsPerPageInput.disabled = settings.autoPaginate;
            autoPaginateCheckbox.checked = settings.autoPaginate;
            autoShortenLocationCheckbox.checked = settings.autoShortenLocation;
            showTimestampCheckbox.checked = settings.showTimestamp;
            showUrlCheckbox.checked = settings.showUrl;
            gSheetUrlInput.value = settings.gSheetUrl;
            gradientStartColorInput.value = settings.customGradient.start;
            gradientEndColorInput.value = settings.customGradient.end;
            
            // Populate text style editor dropdowns
            textStyleCategorySelect.innerHTML = Object.keys(textStyleCategories).map(key => `<option value="${key}">${textStyleCategories[key].label}</option>`).join('');
            fontFamilySelect.innerHTML = Object.keys(availableFonts).map(key => `<option value="${key}">${availableFonts[key]}</option>`).join('');
            
            populateTextStyleEditor(); // Populate with the first category's style
        }
        
        function updateDynamicRecommendations() {
             if (settings.posterSize === '1080x1350') {
                 eventsPerPageRecommendation.textContent = 'Recommended: 5 for 4:5 size.';
            } else {
                 eventsPerPageRecommendation.textContent = 'Recommended: 9 for Story size.';
            }
        }

        function updatePosterLook() {
            // Update size-related classes
            if (settings.posterSize === '1080x1350') {
                posterContent.classList.remove('size-story');
                posterContent.classList.add('size-post');
            } else {
                posterContent.classList.remove('size-post');
                posterContent.classList.add('size-story');
            }
            updatePreviewSize();
            updateDynamicRecommendations();

            // Update text content from settings
            previewTitle.textContent = settings.title;
            previewSubtitle.textContent = settings.subtitle;
            previewFooter.textContent = settings.footer;
            
            // Toggle control visibility
            customGradientControls.classList.toggle('hidden', settings.background !== 'custom-gradient');
            imageBackgroundControls.classList.toggle('hidden', settings.background !== 'image');

            // Apply background styles
            posterBackgroundImage.style.filter = `blur(${settings.backgroundBlur}px)`;
            
            if (settings.background === 'image') {
                posterBackgroundImage.style.backgroundImage = currentImageObjectUrl ? `url(${currentImageObjectUrl})` : 'none';
                posterBackgroundOverlay.style.backgroundImage = 'none';
                posterBackgroundOverlay.style.backgroundColor = settings.overlayColor;
                posterBackgroundOverlay.style.opacity = settings.overlayOpacity;
            } else {
                 posterBackgroundImage.style.backgroundImage = 'none';
                 posterBackgroundImage.style.filter = 'none';
                 const gradient = settings.background === 'custom-gradient'
                    ? `linear-gradient(to bottom right, ${settings.customGradient.start}, ${settings.customGradient.end})`
                    : gradients[settings.background];
                posterBackgroundOverlay.style.backgroundImage = gradient;
                posterBackgroundOverlay.style.backgroundColor = 'transparent';
                posterBackgroundOverlay.style.opacity = 1;
            }
            
            previewTimestamp.style.display = 'none';
            previewUrl.style.display = 'none';

            // Apply all text styles
            updateAllTextStyles();
        }

        // --- EVENT HANDLERS & LOGIC ---
        function formatPrice(price) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(price);
        }
        
        const parseDate = (dateStr) => {
            if (!dateStr || dateStr.toUpperCase() === 'TBA') return null; // Handle TBA dates
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            const [day, month, year] = parts.map(Number);
            if(isNaN(day) || isNaN(month) || isNaN(year)) return null;
            return new Date(year, month - 1, day);
        };
        
        const sortEvents = () => {
            events.sort((a, b) => {
                const dateA = parseDate(a.date);
                const dateB = parseDate(b.date);

                if (dateA === null && dateB === null) return 0; // Both are TBA
                if (dateA === null) return 1; // a is TBA, put it last
                if (dateB === null) return -1; // b is TBA, put it last

                return dateA - dateB;
            });
        };

        async function addEvent(e) {
            e.preventDefault();
            
            let priceText;
            if (isFreeCheckbox.checked) {
                priceText = 'Free';
            } else if (isTbaCheckbox.checked) {
                priceText = 'TBA';
            } else {
                 const priceValueStr = eventPriceInput.value.trim();
                 priceText = priceValueStr === '' ? 'TBA' : formatPrice(parseFloat(priceValueStr));
            }

            const newEvent = {
                name: eventNameInput.value,
                date: isDateTbaCheckbox.checked ? 'TBA' : eventDateInput.value,
                location: eventLocationInput.value,
                socialMedia: eventSocialInput.value,
                priceText: priceText,
                isFree: isFreeCheckbox.checked
            };

            events.push(newEvent);
            sortEvents();
            await saveState();
            renderEventsInPreview();
            eventForm.reset();
            togglePriceInput();
            toggleDateInput();
        }

        function handleListInteraction(e) {
            const button = e.target.closest('button[data-action]');
            if (!button) return;

            const action = button.dataset.action;
            const index = parseInt(button.dataset.index, 10);

            if (action === 'remove') {
                events.splice(index, 1);
                saveState();
                renderEventsInPreview();
            }
        }
        
        function clearAllEvents() {
            if (events.length === 0) return;
            showConfirm('Clear All Events', 'Are you sure you want to delete all events? This action cannot be undone.', async () => {
                events = [];
                await saveState();
                renderEventsInPreview();
            });
        }

        function togglePriceInput(initiator = null) {
            if (initiator === 'free' && isFreeCheckbox.checked) {
                isTbaCheckbox.checked = false;
                eventPriceInput.disabled = true;
                eventPriceInput.value = '';
            } else if (initiator === 'tba' && isTbaCheckbox.checked) {
                 isFreeCheckbox.checked = false;
                 eventPriceInput.disabled = true;
                 eventPriceInput.value = '';
            } else if (initiator === 'input') {
                 isFreeCheckbox.checked = false;
                 isTbaCheckbox.checked = false;
                 eventPriceInput.disabled = false;
            } else if (!isFreeCheckbox.checked && !isTbaCheckbox.checked){
                 eventPriceInput.disabled = false;
            }
        }

        function toggleDateInput() {
            if (isDateTbaCheckbox.checked) {
                eventDateInput.disabled = true;
                eventDateInput.value = "TBA";
                if(datepickerInstance) datepickerInstance.hide();
            } else {
                eventDateInput.disabled = false;
                eventDateInput.value = "";
            }
        }
        
        async function exportData() {
            if (events.length === 0) {
                showAlert('Cannot Export', 'There are no events to export. Please add at least one event.');
                return;
            }
            
            const includeImage = exportWithImageCheckbox.checked;
            let exportableSettings = JSON.parse(JSON.stringify(settings)); // Deep clone to avoid mutation

            if (includeImage && settings.backgroundImage instanceof Blob) {
                const toBase64 = file => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
                exportableSettings.backgroundImage = await toBase64(settings.backgroundImage);
            } else {
                // If not including image or if it's not a blob, nullify it
                exportableSettings.backgroundImage = null;
            }

            const dataStr = JSON.stringify({ events, settings: exportableSettings }, null, 2);
            const dataBlob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.download = `event-poster-data-${new Date().toISOString().slice(0, 10)}.json`;
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        async function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const fileName = file.name.toLowerCase();

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    let importedState = null;
                    let importedEvents = null;

                    if (fileName.endsWith('.json')) {
                        importedState = JSON.parse(e.target.result);
                        if (importedState && importedState.settings) {
                           importedEvents = importedState.events || [];
                            const loadedSettings = importedState.settings;
                            settings = { ...settings, ...loadedSettings };
                            if (typeof settings.backgroundImage === 'string' && settings.backgroundImage.startsWith('data:image')) {
                                 const fetchRes = await fetch(settings.backgroundImage);
                                 settings.backgroundImage = await fetchRes.blob();
                            } else {
                                settings.backgroundImage = null;
                            }
                        } else {
                             showAlert('Import Error', 'Invalid JSON file format.');
                             return;
                        }
                    } else if (fileName.endsWith('.csv')) {
                         const csvText = e.target.result;
                         await new Promise((resolve, reject) => {
                             findAndProcessCsv(csvText, (results) => {
                                const parsedEvents = parseCsvData(results);
                                if(parsedEvents) {
                                    importedEvents = parsedEvents;
                                    resolve();
                                } else {
                                    reject(new Error("CSV parsing failed.")); 
                                }
                            });
                        });
                    }
                    
                    if (importedEvents !== null) {
                        events = importedEvents;
                        if (!settings.textStyles) settings.textStyles = JSON.parse(JSON.stringify(defaultTextStyles));
                        if (!settings.customGradient) settings.customGradient = { start: "#1f2937", end: "#111827" };

                        sortEvents();
                        await saveState();
                        await loadState(); // Reload to create new object URL for the image
                        updateFormControls();
                        updatePosterLook();
                        renderEventsInPreview();
                        showStatusMessage('Data imported successfully!');
                    }
                } catch (error) {
                    console.error("Error parsing imported file:", error);
                    if (error.message !== "CSV parsing failed.") {
                        showAlert('Import Error', 'Could not read or parse the selected file.');
                    }
                }
            };
            reader.readAsText(file);
            importInput.value = '';
        }

        function findAndProcessCsv(csvText, onComplete) {
            const lines = csvText.split('\n');
            let headerRowIndex = -1;
            
            const oldHeadersSample = ['name', 'date'];
            const newHeadersSample = ['tanggal', 'event'];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].toLowerCase().trim();
                const hasOld = oldHeadersSample.every(h => line.includes(h));
                const hasNew = newHeadersSample.every(h => line.includes(h));
                if (hasOld || hasNew) {
                    headerRowIndex = i;
                    break;
                }
            }

            if (headerRowIndex === -1) {
                showAlert('CSV Error', 'Could not find a valid header row. Please ensure columns like "name", "date" or "Tanggal", "Event" exist.');
                onComplete({ data: [], errors: [{message: "Header not found"}]});
                return;
            }

            const csvDataFromHeaders = lines.slice(headerRowIndex).join('\n');
            
            Papa.parse(csvDataFromHeaders, {
                header: true,
                skipEmptyLines: true,
                complete: onComplete
            });
        }
        
        function parseCsvData(results) {
            if (results.errors.length > 0 && results.errors.some(e => e.code !== 'TooManyFields' && e.code !== 'TooFewFields')) {
                console.error("CSV Parsing Errors:", results.errors);
                showAlert('Parsing Error', 'Could not parse the CSV data. Please check the file format.');
                return null;
            }
            
            const actualHeaders = results.meta.fields.map(h => h.trim().toLowerCase());
            
            const oldHeaders = ['name', 'date', 'location', 'socialmedia', 'pricetext', 'isfree'];
            const newHeaders = ['tanggal', 'event', 'lokasi', 'ticket', 'link event'];
            
            const hasOldHeaders = oldHeaders.every(h => actualHeaders.includes(h));
            const hasNewHeaders = newHeaders.every(h => actualHeaders.includes(h));

            if (!hasOldHeaders && !hasNewHeaders) {
                const missingOld = oldHeaders.filter(h => !actualHeaders.includes(h));
                const missingNew = newHeaders.filter(h => !actualHeaders.includes(h));
                let errorMessage = 'The CSV is missing required columns. ';

                if (missingOld.length < missingNew.length) {
                    errorMessage += `Standard format is missing: ${missingOld.join(', ')}.`;
                } else {
                    errorMessage += `Custom format is missing: ${missingNew.join(', ')}.`;
                }
                 showAlert('Incorrect Columns', errorMessage);
                 return null;
            }

            const isNewFormat = hasNewHeaders;

            const parsedEvents = results.data.map(row => {
                const lowerCaseRow = {};
                for (const key in row) {
                    lowerCaseRow[key.trim().toLowerCase()] = row[key];
                }

                if (isNewFormat) {
                    const monthMap = { 
                        'januari': '01', 'january': '01',
                        'februari': '02', 'february': '02',
                        'maret': '03', 'march': '03',
                        'april': '04', 
                        'mei': '05', 'may': '05',
                        'juni': '06', 'june': '06',
                        'juli': '07', 'july': '07',
                        'agustus': '08', 'august': '08',
                        'september': '09', 
                        'oktober': '10', 'october': '10',
                        'november': '11', 
                        'desember': '12', 'december': '12'
                    };
                    const dateStr = (lowerCaseRow['tanggal'] || '').trim();
                    let formattedDate = dateStr; 
                    
                    if (dateStr.toUpperCase() !== 'TBA' && dateStr) {
                        const dateParts = dateStr.split(' ');
                        if (dateParts.length === 3) {
                            const day = dateParts[0].padStart(2, '0');
                            const month = monthMap[dateParts[1].toLowerCase()];
                            const year = dateParts[2];
                            if (day && month && year) {
                                formattedDate = `${day}/${month}/${year}`;
                            }
                        }
                    } else {
                        formattedDate = 'TBA';
                    }

                    let ticketValue = (lowerCaseRow['ticket'] || '').trim();
                    let isTicketFree = false;
                    const ticketUpper = ticketValue.toUpperCase();

                    if (ticketUpper === 'FREE') {
                        isTicketFree = true;
                    } else if (ticketUpper !== 'TBA') {
                        if (ticketUpper.includes('-')) {
                            const firstValue = ticketUpper.split('-')[0].trim();
                            const number = parseFloat(firstValue.replace('K', '')) * 1000;
                            if (!isNaN(number)) {
                                ticketValue = formatPrice(number) + "+";
                            }
                        } else if (ticketUpper.endsWith('K')) {
                            const number = parseFloat(ticketUpper.replace('K', '')) * 1000;
                            if (!isNaN(number)) {
                                ticketValue = formatPrice(number);
                            }
                        } else if (!isNaN(parseFloat(ticketValue))) {
                            ticketValue = formatPrice(parseFloat(ticketValue));
                        }
                    }
                    

                    const socialValue = (lowerCaseRow['link event'] || '').trim();
                    let socialHandle = socialValue;

                    if (socialValue) {
                        try {
                            const url = new URL(socialValue);
                            const pathParts = url.pathname.split('/').filter(Boolean);
                            socialHandle = pathParts.pop() || '';
                        } catch (e) { }
                        if (socialHandle && !socialHandle.startsWith('@')) {
                            socialHandle = '@' + socialHandle;
                        }
                    }
                    
                    return {
                        name: lowerCaseRow['event'] || '',
                        date: formattedDate,
                        location: lowerCaseRow['lokasi'] || '',
                        socialMedia: socialHandle,
                        priceText: ticketValue,
                        isFree: isTicketFree
                    };

                } else {
                    return {
                        name: lowerCaseRow.name || '',
                        date: lowerCaseRow.date || '',
                        location: lowerCaseRow.location || '',
                        socialMedia: lowerCaseRow.socialmedia || '',
                        priceText: lowerCaseRow.pricetext || '',
                        isFree: String(lowerCaseRow.isfree).toUpperCase() === 'TRUE'
                    };
                }
            });

            return parsedEvents;
        }
        
        // --- Direct Canvas Edit Handlers ---
        const settingToInputMap = {
            title: posterTitleInput,
            subtitle: posterSubtitleInput,
            footer: posterFooterInput
        };

        function handleDirectEdit(e) {
            const element = e.target;
            if (!element || !element.isContentEditable) return;
            const key = element.dataset.setting;
            
            if (key) {
                const newValue = element.textContent.trim();
                if (settings[key] !== newValue) {
                    settings[key] = newValue;
                    settingToInputMap[key].value = newValue;
                    debouncedSaveState();
                }
            } else if (element.dataset.field) {
                 const index = parseInt(element.dataset.index, 10);
                 const field = element.dataset.field;
                 const newValue = element.textContent.trim();
                
                 if (!events[index]) return;

                 if (field === 'priceText') {
                       const upperCaseValue = newValue.toUpperCase();
                       let newPriceText;
                       if (upperCaseValue === 'FREE') {
                           newPriceText = 'Free';
                           events[index].isFree = true;
                       } else if (upperCaseValue === 'TBA') {
                           newPriceText = 'TBA';
                           events[index].isFree = false;
                       } else {
                           const numericValue = parseFloat(newValue.replace(/[^0-9]/g, ''));
                           if (!isNaN(numericValue)) {
                               newPriceText = formatPrice(numericValue);
                               events[index].isFree = false;
                           } else {
                               newPriceText = 'TBA';
                               events[index].isFree = false;
                           }
                       }
                      
                       if (events[index].priceText !== newPriceText) {
                           events[index].priceText = newPriceText;
                           debouncedSaveState();
                           renderEventsInPreview(); 
                       }
                 } else if (field === 'date') {
                     if (events[index][field] !== newValue) {
                         events[index][field] = newValue;
                         sortEvents();
                         debouncedSaveState();
                         renderEventsInPreview();
                     }
                 }
                 else {
                       if (events[index][field] !== newValue) {
                           events[index][field] = newValue;
                           debouncedSaveState();
                       }
                 }
            }
        }
        
        function preventLineBreaks(e) {
            if (e.target.isContentEditable && e.key === 'Enter') {
                e.preventDefault();
                e.target.blur();
            }
        }
        
        // --- Image processing function ---
        async function getProcessedImage() {
            if (!(settings.backgroundImage instanceof Blob)) {
                return null;
            }
             if (settings.backgroundBlur === 0) {
                return currentImageObjectUrl;
            }

            const imageBitmap = await createImageBitmap(settings.backgroundImage);
            const canvas = document.createElement('canvas');
            canvas.width = imageBitmap.width;
            canvas.height = imageBitmap.height;
            const ctx = canvas.getContext('2d');
            
            ctx.filter = `blur(${settings.backgroundBlur}px)`;
            ctx.drawImage(imageBitmap, 0, 0);
            
            return canvas.toDataURL();
        }


        async function downloadImage() {
            if (events.length === 0) {
                showAlert('Cannot Download', "Please add at least one event before downloading.");
                return;
            }
            
            loadingIndicator.classList.remove('hidden');
            downloadBtn.disabled = true;
            downloadBtn.classList.add('opacity-50', 'cursor-not-allowed');

            const delay = ms => new Promise(res => setTimeout(res, ms));
            const [width, height] = settings.posterSize.split('x').map(Number);
            
            let pageChunks = [];

            if (settings.autoPaginate) {
                loadingIndicator.textContent = 'Calculating page layout...';
                await delay(50); // Allow UI to update
                
                const measureClone = posterContent.cloneNode(true);
                measureClone.style.position = 'absolute';
                measureClone.style.left = '-9999px';
                measureClone.style.top = '-9999px';
                measureClone.style.visibility = 'hidden';
                document.body.appendChild(measureClone);
                
                const listContainer = measureClone.querySelector('.event-list-container');
                const availableHeight = listContainer.clientHeight;
                
                let remainingEvents = [...events];
                
                while(remainingEvents.length > 0) {
                    let currentChunk = [];
                    listContainer.innerHTML = '';
                    for (let i = 0; i < remainingEvents.length; i++) {
                        const event = remainingEvents[i];
                        const eventElement = createEventElement(event, i, false);
                        listContainer.appendChild(eventElement);

                        if(listContainer.scrollHeight > availableHeight) {
                            if (currentChunk.length === 0) {
                                currentChunk.push(event); 
                            }
                            break;
                        }
                        currentChunk.push(event);
                    }
                    pageChunks.push(currentChunk);
                    remainingEvents.splice(0, currentChunk.length);
                }

                document.body.removeChild(measureClone);

            } else {
                 const eventsPerPage = parseInt(eventsPerPageInput.value, 10) || 9;
                 for (let i = 0; i < events.length; i += eventsPerPage) {
                    pageChunks.push(events.slice(i, i + eventsPerPage));
                }
            }
            
            // Pre-process the image once if needed
            let processedImageUrl = null;
            if(settings.background === 'image' && settings.backgroundImage) {
                loadingIndicator.textContent = `Processing background image...`;
                processedImageUrl = await getProcessedImage();
            }


            for (let i = 0; i < pageChunks.length; i++) {
                const page = i + 1;
                loadingIndicator.textContent = `Generating image ${page} of ${pageChunks.length}...`;
                const chunk = pageChunks[i];

                const posterClone = posterContent.cloneNode(true);
                posterClone.querySelectorAll('[contenteditable="true"]').forEach(el => el.setAttribute('contenteditable', 'false'));
                
                // Remove the CSS filter from the clone to prevent conflicts
                const cloneBgImage = posterClone.querySelector('#poster-background-image');
                cloneBgImage.style.filter = 'none';

                // Apply the pre-processed image to the clone
                if (processedImageUrl) {
                    cloneBgImage.style.backgroundImage = `url(${processedImageUrl})`;
                }


                const listInClone = posterClone.querySelector('.event-list-container');
                listInClone.innerHTML = '';

                chunk.forEach((event, index) => {
                    const eventElement = createEventElement(event, index, false);
                    listInClone.appendChild(eventElement);
                });

                const timestampEl = posterClone.querySelector('#preview-timestamp');
                if (settings.showTimestamp) {
                    timestampEl.textContent = `Generated on: ${new Date().toLocaleString()}`;
                    timestampEl.style.display = 'block';
                } else {
                    timestampEl.style.display = 'none';
                }
                
                const urlEl = posterClone.querySelector('#preview-url');
                if (settings.showUrl) {
                    urlEl.textContent = window.location.href;
                    urlEl.style.display = 'block';
                } else {
                     urlEl.style.display = 'none';
                }

                posterClone.style.position = 'absolute';
                posterClone.style.top = '-9999px';
                posterClone.style.left = '0px';
                posterClone.style.zIndex = '-100';
                document.body.appendChild(posterClone);
                
                try {
                    await delay(200);

                    const canvas = await html2canvas(posterClone, {
                        scale: 1, 
                        useCORS: true,
                        logging: false,
                        backgroundColor: null, 
                        width: width,
                        height: height,
                        windowWidth: width,
                        windowHeight: height
                    });

                    const link = document.createElement('a');
                    link.download = `event-poster-${page}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    link.remove();
                    await delay(500);
                } catch (err) {
                    console.error('Oops, something went wrong!', err);
                    showAlert('Image Generation Failed', `An error occurred while creating image ${page}. Please try again.`);
                    break;
                } finally {
                    document.body.removeChild(posterClone);
                }
            }

            loadingIndicator.classList.add('hidden');
            loadingIndicator.textContent = `Generating image... please wait.`;
            downloadBtn.disabled = false;
            downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        
        // --- Text Style Editor Logic ---
        function populateTextStyleEditor() {
            const categoryKey = textStyleCategorySelect.value;
            const styles = settings.textStyles[categoryKey];
            if (!styles) return;

            fontFamilySelect.value = styles.fontFamily;
            textColorInput.value = styles.color;
            getEl('font-size-input').value = styles.fontSize;
            getEl('font-weight-input').value = styles.fontWeight;
            getEl('stroke-color').value = styles.strokeColor;
            getEl('stroke-width-input').value = styles.strokeWidth.toFixed(1);
            getEl('shadow-color').value = styles.shadowColor;
            getEl('shadow-blur-input').value = styles.shadowBlur;
            getEl('shadow-offset-x-input').value = styles.shadowOffsetX;
            getEl('shadow-offset-y-input').value = styles.shadowOffsetY;
            getEl('background-blur-input').value = settings.backgroundBlur;
            getEl('overlay-opacity-input').value = Math.round(settings.overlayOpacity * 100);
        }
        
        function handleTextStyleChange(property, value) {
            const categoryKey = textStyleCategorySelect.value;
            settings.textStyles[categoryKey][property] = value;
            
            // Update the preview immediately
            updatePosterLook();
            debouncedSaveState();
        }

        // Helper to link a slider, number input, and buttons
        function setupNumericStepper(options) {
            const { inputId, upId, downId, callback, isFloat = false, step = 1, min, max } = options;
            const input = getEl(inputId);
            const upBtn = getEl(upId);
            const downBtn = getEl(downId);

            const updateValue = (newValue) => {
                let value = isFloat ? parseFloat(newValue) : parseInt(newValue, 10);
                if (isNaN(value)) value = min !== undefined ? min : 0;
                
                if(min !== undefined) value = Math.max(min, value);
                if(max !== undefined) value = Math.min(max, value);

                input.value = isFloat ? value.toFixed(1) : value;
                callback(value);
            };

            input.addEventListener('change', (e) => updateValue(e.target.value));
            upBtn.addEventListener('click', () => updateValue(parseFloat(input.value) + step));
            downBtn.addEventListener('click', () => updateValue(parseFloat(input.value) - step));
        }

        // --- EVENT LISTENERS ---
        async function attachListeners() {
            // Initial Setup on Load
            datepickerInstance = new Datepicker(eventDateInput, {
                format: 'dd/mm/yyyy',
                autohide: true,
                buttonClass: 'btn'
            }); 
            
            await loadState();
            updateFormControls();
            updatePosterLook();
            renderEventsInPreview();
        
            window.addEventListener('resize', debounce(updatePreviewSize, 100)); 

            const debouncedUpdatePosterLook = debounce(updatePosterLook, 50);

            // General customization listeners
            posterSizeSelect.addEventListener('change', async (e) => { 
                settings.posterSize = e.target.value;
                updateFormControls();
                updatePosterLook(); 
                await saveState();
            });
            posterTitleInput.addEventListener('input', e => { settings.title = e.target.value; previewTitle.textContent = e.target.value; debouncedSaveState(); });
            posterSubtitleInput.addEventListener('input', e => { settings.subtitle = e.target.value; previewSubtitle.textContent = e.target.value; debouncedSaveState(); });
            posterBackgroundSelect.addEventListener('change', e => { settings.background = e.target.value; updatePosterLook(); saveState(); });
            posterFooterInput.addEventListener('input', e => { settings.footer = e.target.value; previewFooter.textContent = e.target.value; debouncedSaveState(); });
            eventsPerPageInput.addEventListener('input', e => { settings.eventsPerPage = parseInt(e.target.value, 10); saveState(); });
            showTimestampCheckbox.addEventListener('change', e => { settings.showTimestamp = e.target.checked; saveState(); });
            showUrlCheckbox.addEventListener('change', e => { settings.showUrl = e.target.checked; saveState(); });
            gradientStartColorInput.addEventListener('input', e => { settings.customGradient.start = e.target.value; debouncedUpdatePosterLook(); debouncedSaveState(); });
            gradientEndColorInput.addEventListener('input', e => { settings.customGradient.end = e.target.value; debouncedUpdatePosterLook(); debouncedSaveState(); });
            
            // Experimental features
            autoPaginateCheckbox.addEventListener('change', (e) => {
                settings.autoPaginate = e.target.checked;
                eventsPerPageInput.disabled = settings.autoPaginate;
                saveState();
            });
             autoShortenLocationCheckbox.addEventListener('change', (e) => {
                settings.autoShortenLocation = e.target.checked;
                renderEventsInPreview();
                saveState();
            });

            // Image background listeners
            uploadImageBtn.addEventListener('click', () => backgroundImageInput.click());
            backgroundImageInput.addEventListener('change', e => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (currentImageObjectUrl) URL.revokeObjectURL(currentImageObjectUrl);
                
                settings.backgroundImage = file;
                currentImageObjectUrl = URL.createObjectURL(file);
                
                updatePosterLook();
                saveState();
                backgroundImageInput.value = '';
            });
            removeImageBtn.addEventListener('click', () => {
                if (currentImageObjectUrl) URL.revokeObjectURL(currentImageObjectUrl);
                currentImageObjectUrl = null;
                settings.backgroundImage = null;
                updatePosterLook();
                saveState();
            });


            // Direct editing listeners
            posterContent.addEventListener('focusout', handleDirectEdit);
            posterContent.addEventListener('keydown', preventLineBreaks);

            // Form listeners
            eventForm.addEventListener('submit', addEvent);
            isFreeCheckbox.addEventListener('change', () => togglePriceInput('free'));
            isTbaCheckbox.addEventListener('change', () => togglePriceInput('tba'));
            eventPriceInput.addEventListener('input', () => togglePriceInput('input'));
            isDateTbaCheckbox.addEventListener('change', toggleDateInput);

            // Button listeners
            downloadBtn.addEventListener('click', downloadImage);
            clearBtn.addEventListener('click', clearAllEvents);
            sortBtn.addEventListener('click', async () => {
                sortEvents();
                await saveState();
                renderEventsInPreview();
            });
            previewListContainer.addEventListener('click', handleListInteraction);
            exportBtn.addEventListener('click', exportData);
            importBtn.addEventListener('click', () => importInput.click());
            importInput.addEventListener('change', importData);
            
            // Text Style Editor Listeners
            textStyleCategorySelect.addEventListener('change', populateTextStyleEditor);

            fontFamilySelect.addEventListener('change', e => handleTextStyleChange('fontFamily', e.target.value));
            textColorInput.addEventListener('input', e => handleTextStyleChange('color', e.target.value));
            
            setupNumericStepper({ inputId: 'font-size-input', upId: 'font-size-up', downId: 'font-size-down', callback: (value) => handleTextStyleChange('fontSize', value), min: 1 });
            setupNumericStepper({ inputId: 'font-weight-input', upId: 'font-weight-up', downId: 'font-weight-down', callback: (value) => handleTextStyleChange('fontWeight', value), step: 100, min: 100, max: 900 });
            setupNumericStepper({ inputId: 'stroke-width-input', upId: 'stroke-width-up', downId: 'stroke-width-down', callback: (value) => handleTextStyleChange('strokeWidth', value), isFloat: true, step: 0.1, min: 0, max: 10 });
            
            getEl('stroke-color').addEventListener('input', e => handleTextStyleChange('strokeColor', e.target.value));
            getEl('shadow-color').addEventListener('input', e => handleTextStyleChange('shadowColor', e.target.value));
            
            setupNumericStepper({ inputId: 'shadow-blur-input', upId: 'shadow-blur-up', downId: 'shadow-blur-down', callback: (value) => handleTextStyleChange('shadowBlur', value), min: 0, max: 50 });
            setupNumericStepper({ inputId: 'shadow-offset-x-input', upId: 'shadow-offset-x-up', downId: 'shadow-offset-x-down', callback: (value) => handleTextStyleChange('shadowOffsetX', value), min: -50, max: 50 });
            setupNumericStepper({ inputId: 'shadow-offset-y-input', upId: 'shadow-offset-y-up', downId: 'shadow-offset-y-down', callback: (value) => handleTextStyleChange('shadowOffsetY', value), min: -50, max: 50 });

            setupNumericStepper({ inputId: 'background-blur-input', upId: 'background-blur-up', downId: 'background-blur-down', callback: (value) => { settings.backgroundBlur = value; updatePosterLook(); debouncedSaveState(); }, min: 0, max: 50 });
            setupNumericStepper({ inputId: 'overlay-opacity-input', upId: 'overlay-opacity-up', downId: 'overlay-opacity-down', callback: (value) => { settings.overlayOpacity = value / 100; updatePosterLook(); debouncedSaveState(); }, min: 0, max: 100 });
       
            // Google Sheet Fetch listener
            fetchGSheetBtn.addEventListener('click', async () => {
                const url = gSheetUrlInput.value.trim();
                if (!url) {
                    showAlert('Invalid URL', 'Please enter a Google Sheet URL.');
                    return;
                }
                
                // Save the URL for next time
                settings.gSheetUrl = url;
                await saveState();

                showStatusMessage('Fetching data...');
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Network response was not ok: ${response.statusText}`);
                    }
                    const csvText = await response.text();
                    
                    findAndProcessCsv(csvText, async (results) => {
                        const parsedEvents = parseCsvData(results);
                        if (parsedEvents) {
                            events = parsedEvents;
                            sortEvents();
                            await saveState();
                            renderEventsInPreview();
                            showStatusMessage('Data fetched successfully!');
                        }
                    });

                } catch (error) {
                    console.error('Error fetching Google Sheet:', error);
                    showAlert('Fetch Error', 'Could not fetch data from the provided URL. Please ensure it is a valid, publicly published CSV link.');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', attachListeners);

    })();
    </script>
</body>
</html>
