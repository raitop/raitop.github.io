<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Poster Generator (SEKAI Inspired)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas library for converting HTML to image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- VanillaJS Datepicker for calendar input -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css">
    <script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js"></script>
    <!-- Papa Parse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Google Fonts: Roboto for UI, plus others for poster -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Inter:wght@400;700;900&family=Playfair+Display:wght@400;700;900&family=Roboto+Mono:wght@400;700&family=Lato:wght@400;700;900&family=Montserrat:wght@400;700;900&family=Oswald:wght@400;700&family=Lora:wght@400;700&family=Source+Code+Pro:wght@400;700&family=Lobster&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        /* --- Project SEKAI Inspired Theme --- */
        :root {
            --ui-primary: #59d8ff; /* Vibrant Cyan */
            --ui-on-primary: #003641; /* Dark text for on-cyan elements */
            --ui-primary-container: #004e5d; /* Darker cyan container */
            --ui-on-primary-container: #b4ebff; /* Light text for on-cyan-container */
            --ui-surface-container-highest: #2e303d;
            --ui-surface-container: #1c1d26;
            --ui-surface: #0e0f14;
            --ui-on-surface: #e4e1e6;
            --ui-on-surface-variant: #b0c6d2;
            --ui-outline: #41a5d3;
            --ui-outline-variant: #3d4653;
            --ui-error: #ff4aa2; /* Sekai Pink for Danger */
            --ui-on-error: #5c002e; /* Dark pink for on-danger */
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--ui-surface); color: var(--ui-on-surface);
        }

        /* --- Component Styles --- */
        .ui-card {
            background-color: var(--ui-surface-container); border-radius: 1rem;
            border: 1px solid var(--ui-outline-variant);
        }
        .ui-input, .ui-select {
            background-color: var(--ui-surface-container-highest); border: 1px solid var(--ui-outline-variant);
            border-radius: 0.5rem; transition: border-color 0.2s ease, background-color 0.3s;
            padding: 0.75rem 1rem; color: var(--ui-on-surface);
        }
        .ui-input:focus, .ui-select:focus {
            outline: none; border-color: var(--ui-primary);
        }
        
        .ui-btn {
            border-radius: 9999px; padding: 0.75rem 1.5rem; font-weight: 500;
            transition: all 0.2s ease; border: 1px solid transparent; text-transform: uppercase;
        }
        .ui-btn-filled {
            background-color: var(--ui-primary); color: var(--ui-on-primary);
        }
        .ui-btn-filled:hover { filter: brightness(1.1); }
        .ui-btn-tonal {
            background-color: var(--ui-primary-container); color: var(--ui-on-primary-container);
        }
        .ui-btn-tonal:hover { filter: brightness(1.2); }
        .ui-btn-outlined {
            border-color: var(--ui-outline); color: var(--ui-primary);
        }
        .ui-btn-outlined:hover { background-color: rgba(255, 255, 255, 0.1); }
        .ui-btn-danger {
             border-color: var(--ui-error); color: var(--ui-error);
        }
        .ui-btn-danger:hover { background-color: var(--ui-error); color: var(--ui-on-error); }

        /* --- Original Poster Styles (Untouched) --- */
        #poster-content {
            width: 1080px; background-size: cover; background-position: center; display: flex;
            flex-direction: column; position: relative; overflow: hidden;
        }
        #poster-background-image { position: absolute; inset: 0; z-index: 0; background-size: cover; background-position: center; transition: filter 0.3s ease; }
        #poster-content.size-story { height: 1920px; padding: 96px; }
        #poster-content.size-story .event-list-container { flex-grow: 1; }
        #poster-content.size-post { height: 1350px; padding: 64px; }
        #poster-content.size-post #poster-header { margin-top: 24px; }
        #poster-content.size-post .event-list-container { height: 874px; flex-grow: 0; flex-shrink: 0; border-top: 2px solid rgba(255,255,255,0.15); border-bottom: 2px solid rgba(255,255,255,0.15); margin: 20px 0; padding: 32px 0; }
        #poster-content.size-post #poster-footer-wrapper { margin-top: 0; }
        .event-list-container::-webkit-scrollbar { width: 12px; }
        .event-list-container::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .event-list-container::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 10px; border: 3px solid transparent; background-clip: content-box; }
        .event-list-container::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }
        .html2canvas-container .action-buttons { display: none; }
        [contenteditable="true"]:focus { outline: 2px dashed rgba(89, 216, 255, 0.8); box-shadow: 0 0 15px rgba(89, 216, 255, 0.3); border-radius: 8px; }
        
        /* --- Other Helper Styles --- */
        #status-message { transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; opacity: 0; transform: translateY(20px); }
        #status-message.visible { opacity: 1; transform: translateY(0); }
        input[type="color"] { -webkit-appearance: none; border: 1px solid var(--ui-outline); width: 100%; height: 40px; cursor: pointer; border-radius: 1.5rem; background-color: transparent; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 1.5rem; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    </style>
</head>
<body class="sekai-theme">

    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl font-bold tracking-tight">Social Media Event Poster Generator</h1>
            <p class="text-[var(--m3-on-surface-variant)] mt-2 max-w-3xl mx-auto">Create your event poster by adding events and customizing the design. Your work is saved automatically in your browser.</p>
        </header>
        
        <input type="file" id="import-input" class="hidden" accept=".json,.csv">
        <input type="file" id="background-image-input" class="hidden" accept="image/*">


        <div class="flex flex-col lg:grid lg:grid-cols-3 lg:gap-8">

            <!-- Left Column: Event Details Form -->
            <div class="lg:col-span-1 ui-card p-6 space-y-8">
                 <div>
                    <h2 class="text-xl font-medium mb-4 border-b border-[var(--ui-outline-variant)] pb-3">Event Details</h2>
                    <form id="event-form" class="space-y-6">
                        <div>
                            <label for="event-name" class="block text-sm font-medium text-[var(--m3-on-surface-variant)] mb-1">Event Name</label>
                            <input type="text" id="event-name" required class="ui-input w-full">
                        </div>
                        <div>
                            <label for="event-date" class="block text-sm font-medium text-[var(--m3-on-surface-variant)] mb-1">Date</label>
                            <div class="flex items-center space-x-4">
                                <input type="text" id="event-date" placeholder="Select a date" required class="ui-input w-full" autocomplete="off">
                                <div class="flex items-center">
                                    <input id="is-date-tba" type="checkbox" class="h-4 w-4 text-[var(--ui-primary)] focus:ring-[var(--ui-primary)] border-[var(--ui-outline)] rounded bg-transparent">
                                    <label for="is-date-tba" class="ml-2 block text-sm text-[var(--m3-on-surface-variant)]">TBA</label>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="event-location" class="block text-sm font-medium text-[var(--m3-on-surface-variant)] mb-1">Location</label>
                            <input type="text" id="event-location" required class="ui-input w-full">
                        </div>
                         <div>
                            <label for="event-social" class="block text-sm font-medium text-[var(--m3-on-surface-variant)] mb-1">Social Handle</label>
                            <input type="text" id="event-social" placeholder="@username" class="ui-input w-full">
                        </div>
                        <div>
                            <label for="event-price" class="block text-sm font-medium text-[var(--m3-on-surface-variant)] mb-1">Ticket Price (IDR)</label>
                            <div class="flex items-center space-x-4">
                                <input type="number" id="event-price" placeholder="50000" class="ui-input w-full">
                                 <div class="flex items-center">
                                    <input id="is-free" type="checkbox" class="h-4 w-4 text-[var(--ui-primary)] focus:ring-[var(--ui-primary)] border-[var(--ui-outline)] rounded bg-transparent">
                                    <label for="is-free" class="ml-2 block text-sm text-[var(--m3-on-surface-variant)]">Free</label>
                                </div>
                                 <div class="flex items-center">
                                    <input id="is-tba" type="checkbox" class="h-4 w-4 text-[var(--ui-primary)] focus:ring-[var(--ui-primary)] border-[var(--ui-outline)] rounded bg-transparent">
                                    <label for="is-tba" class="ml-2 block text-sm text-[var(--m3-on-surface-variant)]">TBA</label>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full ui-btn ui-btn-filled">Add Event to List</button>
                    </form>
                </div>
                <div>
                    <h2 class="text-xl font-medium mb-4 border-b border-[var(--ui-outline-variant)] pb-3">Data Management</h2>
                    <div class="space-y-4">
                         <div>
                            <label for="g-sheet-url" class="block text-sm font-medium text-[var(--m3-on-surface-variant)] mb-1">Google Sheet URL</label>
                            <input type="url" id="g-sheet-url" placeholder="Published sheet CSV link" class="ui-input w-full">
                            <button id="fetch-g-sheet" class="w-full mt-2 ui-btn ui-btn-tonal flex items-center justify-center space-x-2"><span>Fetch Live Data</span></button>
                         </div>
                        <div class="border-t border-[var(--ui-outline-variant)] pt-4 space-y-4">
                             <div class="grid grid-cols-2 gap-4">
                                 <button id="import-btn" class="ui-btn ui-btn-outlined flex items-center justify-center space-x-2"><span>Import</span></button>
                                 <button id="export-btn" class="ui-btn ui-btn-outlined flex items-center justify-center space-x-2"><span>Export</span></button>
                             </div>
                            <div class="flex items-center justify-center">
                                <input id="export-with-image" name="export-with-image" type="checkbox" class="h-4 w-4 text-[var(--ui-primary)] focus:ring-[var(--ui-primary)] border-[var(--ui-outline)] rounded bg-transparent" checked>
                                <label for="export-with-image" class="ml-2 block text-sm text-[var(--m3-on-surface-variant)]">Include background in export</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Middle Column: Poster Preview -->
            <div class="lg:col-span-1 flex-1 flex flex-col items-center">
                <h2 class="text-xl font-medium mb-4 text-center">Poster Preview</h2>
                <div id="preview-wrapper" class="w-full max-w-[360px] md:max-w-[450px] shadow-2xl rounded-xl overflow-hidden bg-black">
                    <div id="poster-scaler" class="origin-top-left">
                        <div id="poster-content" class="text-white">
                            <div id="poster-background-image"></div>
                            <div id="poster-background-overlay" class="absolute inset-0 z-10"></div>
                            <header id="poster-header" class="text-center relative z-20 flex-shrink-0">
                                <h1 id="preview-title" class="font-black tracking-tighter uppercase" contenteditable="true" data-setting="title"></h1>
                                <p id="preview-subtitle" class="text-5xl text-gray-400 mt-2" contenteditable="true" data-setting="subtitle"></p>
                            </header>
                            <main class="event-list-container overflow-y-auto py-8 px-4 relative z-20">
                            </main>
                            <div id="poster-footer-wrapper" class="mt-auto pt-4 relative z-20 flex-shrink-0">
                                <p id="preview-timestamp" class="text-center text-gray-500 text-xl mb-2"></p>
                                <footer id="preview-footer" class="text-center text-gray-500 text-2xl" contenteditable="true" data-setting="footer"></footer>
                                <p id="preview-url" class="text-center text-gray-600 text-lg mt-1"></p>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="w-full max-w-[360px] md:max-w-[450px] mt-4 space-y-2">
                     <button id="download-btn" class="w-full ui-btn ui-btn-filled flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zm14-9h-4V3H9v8H5l7 7 7-7z"/></svg>
                        <span>Generate & Download</span>
                    </button>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="sort-btn" class="w-full ui-btn ui-btn-tonal flex items-center justify-center space-x-2 text-xs"><span>Sort by Date</span></button>
                        <button id="clear-btn" class="w-full ui-btn ui-btn-danger flex items-center justify-center space-x-2 text-xs"><span>Clear Events</span></button>
                    </div>
                    <div id="loading-indicator" class="hidden text-center mt-4 text-[var(--ui-primary)]">Generating image... please wait.</div>
                </div>
            </div>
            
            <!-- Right Column: Other Controls -->
            <div id="controls-accordion" class="lg:col-span-1 ui-card p-6 space-y-2">
                 <div class="accordion-item">
                    <button class="accordion-header w-full flex justify-between items-center text-left text-xl font-medium p-3 -m-3 rounded-lg hover:bg-[rgba(255,255,255,0.08)] transition">
                        <span>Poster Settings</span>
                        <svg class="w-6 h-6 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div class="accordion-content space-y-6 pt-4 mt-2 border-t border-[var(--ui-outline-variant)]">
                        <div>
                            <label for="poster-size" class="block text-sm font-medium text-[var(--m3-on-surface-variant)] mb-1">Poster Size</label>
                            <select id="poster-size" class="ui-select w-full">
                                <option value="1080x1920">1080 x 1920 (Story)</option>
                                <option value="1080x1350">1080 x 1350 (Post 4:5)</option>
                            </select>
                        </div>
                        <div>
                            <label for="poster-title" class="block text-sm font-medium text-[var(--m3-on-surface-variant)] mb-1">Title Text</label>
                            <input type="text" id="poster-title" class="ui-input w-full">
                        </div>
                        <div>
                            <label for="poster-subtitle" class="block text-sm font-medium text-[var(--m3-on-surface-variant)] mb-1">Subtitle Text</label>
                            <input type="text" id="poster-subtitle" class="ui-input w-full">
                        </div>
                        <div>
                            <label for="poster-background" class="block text-sm font-medium text-[var(--m3-on-surface-variant)] mb-1">Background Type</label>
                            <select id="poster-background" class="ui-select w-full">
                                <option value="deep-space">Deep Space (Default)</option>
                                <option value="sunset">Sunset</option>
                                <option value="oceanic">Oceanic</option>
                                <option value="minty">Minty</option>
                                <option value="royal">Royal</option>
                                <option value="gotham">Gotham</option>
                                <option value="custom-gradient">Custom Gradient</option>
                                <option value="image">Image</option>
                            </select>
                        </div>
                        <div id="custom-gradient-controls" class="hidden space-y-2 pt-4 border-t border-[var(--ui-outline-variant)]">
                            <div class="flex items-center justify-between">
                                <label for="gradient-start-color" class="text-sm font-medium text-[var(--m3-on-surface-variant)]">Start</label>
                                <input type="color" id="gradient-start-color" value="#1f2937" class="w-2/5">
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="gradient-end-color" class="text-sm font-medium text-[var(--m3-on-surface-variant)]">End</label>
                                 <input type="color" id="gradient-end-color" value="#111827" class="w-2/5">
                            </div>
                        </div>
                        <div id="image-background-controls" class="hidden space-y-4 pt-4 border-t border-[var(--ui-outline-variant)]">
                            <div class="grid grid-cols-2 gap-2">
                                <button id="upload-image-btn" class="ui-btn ui-btn-tonal text-xs">Upload Image</button>
                                <button id="remove-image-btn" class="ui-btn ui-btn-danger text-xs">Remove Image</button>
                            </div>
                             <div>
                                <label for="background-blur-input" class="block text-sm font-medium text-[var(--m3-on-surface-variant)]">Blur</label>
                                <input type="range" id="background-blur-slider" min="0" max="50" step="1" class="w-full mt-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-[var(--m3-on-surface-variant)]">Overlay</label>
                                 <select id="overlay-type" class="ui-select w-full mt-2">
                                     <option value="none">None</option>
                                     <option value="solid">Solid Color</option>
                                     <option value="gradient">Gradient</option>
                                 </select>
                            </div>
                            <div id="overlay-controls" class="hidden space-y-4">
                                <div id="overlay-solid-controls" class="hidden space-y-2">
                                     <div class="flex items-center justify-between">
                                         <label for="overlay-color" class="block text-sm text-[var(--m3-on-surface-variant)]">Overlay Color</label>
                                         <input type="color" id="overlay-color" class="w-2/5">
                                     </div>
                                </div>
                                <div id="overlay-gradient-controls" class="hidden space-y-2">
                                      <div class="flex items-center justify-between">
                                         <label for="overlay-gradient-start" class="block text-sm text-[var(--m3-on-surface-variant)]">Start Color</label>
                                         <input type="color" id="overlay-gradient-start" class="w-2/5">
                                     </div>
                                      <div class="flex items-center justify-between">
                                         <label for="overlay-gradient-end" class="block text-sm text-[var(--m3-on-surface-variant)]">End Color</label>
                                         <input type="color" id="overlay-gradient-end" class="w-2/5">
                                     </div>
                                      <div>
                                        <label for="overlay-gradient-direction" class="block text-sm font-medium text-[var(--m3-on-surface-variant)]">Direction</label>
                                        <input type="range" id="overlay-gradient-direction" min="0" max="360" step="1" class="w-full mt-2">
                                    </div>
                                </div>
                                <div>
                                    <label for="overlay-opacity-slider" class="block text-sm font-medium text-[var(--m3-on-surface-variant)]">Opacity</label>
                                    <input type="range" id="overlay-opacity-slider" min="0" max="1" step="0.05" class="w-full mt-2">
                                </div>
                            </div>
                        </div>
                         <div>
                            <label for="poster-footer" class="block text-sm font-medium text-[var(--m3-on-surface-variant)] mb-1">Footer Text</label>
                            <input type="text" id="poster-footer" class="ui-input w-full">
                        </div>
                         <div id="events-per-page-container">
                            <label for="events-per-page" class="block text-sm font-medium text-[var(--m3-on-surface-variant)] mb-1">Events Per Image</label>
                            <input type="number" id="events-per-page" class="ui-input w-full">
                            <p id="events-per-page-recommendation" class="text-xs text-gray-500 mt-1"></p>
                        </div>
                    </div>
                 </div>

                 <div class="accordion-item">
                    <button class="accordion-header w-full flex justify-between items-center text-left text-xl font-medium p-3 -m-3 rounded-lg hover:bg-[rgba(255,255,255,0.08)] transition">
                        <span>Text & Style</span>
                        <svg class="w-6 h-6 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div class="accordion-content space-y-4 pt-4 mt-2 border-t border-[var(--ui-outline-variant)]">
                        <div>
                            <label for="text-style-category" class="block text-sm font-medium text-[var(--m3-on-surface-variant)] mb-1">Edit Style For</label>
                            <select id="text-style-category" class="ui-select w-full"></select>
                        </div>
                        <div id="text-style-controls" class="space-y-4 pt-4 border-t border-[var(--ui-outline-variant)]">
                            <div>
                                <label for="font-family" class="block text-sm font-medium text-[var(--m3-on-surface-variant)] mb-1">Font Family</label>
                                <select id="font-family" class="ui-select w-full"></select>
                            </div>
                             <div class="flex items-center justify-between">
                                <label for="text-color" class="block text-sm font-medium text-[var(--m3-on-surface-variant)]">Color</label>
                                <input type="color" id="text-color" class="w-2/5">
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="font-size-input" class="block text-sm font-medium text-[var(--m3-on-surface-variant)]">Size</label>
                                <input type="number" id="font-size-input" class="ui-input w-20 text-center p-1" min="1">
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="font-weight-input" class="block text-sm font-medium text-[var(--m3-on-surface-variant)]">Weight</label>
                                <input type="number" id="font-weight-input" class="ui-input w-20 text-center p-1" min="100" max="900" step="100">
                            </div>
                            <div class="space-y-2 pt-2 border-t border-[var(--ui-outline-variant)]">
                                <label class="block text-sm font-medium text-[var(--m3-on-surface-variant)]">Outline</label>
                                 <div class="flex items-center justify-between">
                                     <input type="color" id="stroke-color" class="w-2/5">
                                     <input type="number" id="stroke-width-input" class="ui-input w-20 text-center p-1" min="0" max="10" step="0.1">
                                 </div>
                            </div>
                             <div class="space-y-2 pt-2 border-t border-[var(--ui-outline-variant)]">
                                <label class="block text-sm font-medium text-[var(--m3-on-surface-variant)]">Shadow</label>
                                <div class="flex items-center justify-between">
                                    <label class="text-sm text-[var(--m3-on-surface-variant)]">Color</label>
                                    <input type="color" id="shadow-color" class="w-2/5">
                                </div>
                                <div class="flex items-center justify-between">
                                    <label for="shadow-blur-input" class="text-sm text-[var(--m3-on-surface-variant)]">Blur</label>
                                    <input type="number" id="shadow-blur-input" class="ui-input w-20 text-center p-1" min="0" max="50" step="1">
                                </div>
                                 <div class="flex items-center justify-between">
                                    <label for="shadow-offset-x-input" class="text-sm text-[var(--m3-on-surface-variant)]">X Offset</label>
                                    <input type="number" id="shadow-offset-x-input" class="ui-input w-20 text-center p-1" min="-50" max="50" step="1">
                                </div>
                                <div class="flex items-center justify-between">
                                    <label for="shadow-offset-y-input" class="text-sm text-[var(--m3-on-surface-variant)]">Y Offset</label>
                                    <input type="number" id="shadow-offset-y-input" class="ui-input w-20 text-center p-1" min="-50" max="50" step="1">
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
                 
                 <div class="accordion-item">
                    <button class="accordion-header w-full flex justify-between items-center text-left text-xl font-medium p-3 -m-3 rounded-lg hover:bg-[rgba(255,255,255,0.08)] transition">
                        <span>Advanced</span>
                        <svg class="w-6 h-6 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div class="accordion-content space-y-4 pt-4 mt-2 border-t border-[var(--ui-outline-variant)]">
                        <div class="flex items-center">
                           <input id="auto-paginate" name="auto-paginate" type="checkbox" class="h-4 w-4 text-[var(--ui-primary)] focus:ring-[var(--ui-primary)] border-[var(--ui-outline)] rounded bg-transparent">
                           <label for="auto-paginate" class="ml-2 block text-sm text-[var(--m3-on-surface-variant)]">Auto-fit Events Per Page</label>
                        </div>
                         <div class="flex items-center">
                           <input id="auto-shorten-location" name="auto-shorten-location" type="checkbox" class="h-4 w-4 text-[var(--ui-primary)] focus:ring-[var(--ui-primary)] border-[var(--ui-outline)] rounded bg-transparent">
                           <label for="auto-shorten-location" class="ml-2 block text-sm text-[var(--m3-on-surface-variant)]">Auto-shorten Location Text</label>
                        </div>
                        <div class="flex items-center">
                            <input id="show-timestamp" name="show-timestamp" type="checkbox" class="h-4 w-4 text-[var(--ui-primary)] focus:ring-[var(--ui-primary)] border-[var(--ui-outline)] rounded bg-transparent">
                            <label for="show-timestamp" class="ml-2 block text-sm text-[var(--m3-on-surface-variant)]">Show Generation Timestamp</label>
                        </div>
                         <div class="flex items-center">
                            <input id="show-url" name="show-url" type="checkbox" class="h-4 w-4 text-[var(--ui-primary)] focus:ring-[var(--ui-primary)] border-[var(--ui-outline)] rounded bg-transparent">
                            <label for="show-url" class="ml-2 block text-sm text-[var(--m3-on-surface-variant)]">Show Page URL</label>
                        </div>
                    </div>
                </div>

                <div id="status-container" class="mt-4 h-8">
                     <div id="status-message" class="text-center text-green-400 font-semibold"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="custom-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center p-4">
        <div class="ui-card p-6 w-full max-w-md text-center">
            <h3 id="modal-title" class="text-xl font-medium mb-4">Modal Title</h3>
            <p id="modal-message" class="text-[var(--m3-on-surface-variant)] mb-6">Modal message goes here.</p>
            <div id="modal-buttons" class="flex justify-center space-x-4"></div>
        </div>
    </div>

    <script>
    // --- IIFE Wrapper to encapsulate the entire script ---
    (function() {
        // --- CONFIGURATION CONSTANTS ---
        const CONFIG = {
            DB_NAME: 'PosterGeneratorDB', DB_VERSION: 1, STORE_NAME: 'userState',
            DEBOUNCE_DELAY: 300, STATUS_MESSAGE_DURATION: 2000,
        };
        // --- IndexedDB Helper ---
        const dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open(CONFIG.DB_NAME, CONFIG.DB_VERSION);
            request.onerror = () => reject("Error opening IndexedDB.");
            request.onsuccess = () => resolve(request.result);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(CONFIG.STORE_NAME)) {
                    db.createObjectStore(CONFIG.STORE_NAME);
                }
            };
        });
        const idb = {
            get: (key) => dbPromise.then(db => new Promise((resolve, reject) => {
                const tx = db.transaction(CONFIG.STORE_NAME, 'readonly').objectStore(CONFIG.STORE_NAME).get(key);
                tx.onsuccess = () => resolve(tx.result); tx.onerror = () => reject(tx.error);
            })),
            set: (key, value) => dbPromise.then(db => new Promise((resolve, reject) => {
                const tx = db.transaction(CONFIG.STORE_NAME, 'readwrite').objectStore(CONFIG.STORE_NAME).put(value, key);
                tx.onsuccess = () => resolve(tx.result); tx.onerror = () => reject(tx.error);
            })),
        };

        // --- DOM REFERENCES ---
        const getEl = (id) => document.getElementById(id);
        const eventForm = getEl('event-form'), eventNameInput = getEl('event-name'), eventDateInput = getEl('event-date'),
            isDateTbaCheckbox = getEl('is-date-tba'), eventLocationInput = getEl('event-location'), eventSocialInput = getEl('event-social'),
            eventPriceInput = getEl('event-price'), isFreeCheckbox = getEl('is-free'), isTbaCheckbox = getEl('is-tba'),
            posterSizeSelect = getEl('poster-size'), posterTitleInput = getEl('poster-title'), posterSubtitleInput = getEl('poster-subtitle'),
            posterBackgroundSelect = getEl('poster-background'), posterFooterInput = getEl('poster-footer'),
            eventsPerPageContainer = getEl('events-per-page-container'), eventsPerPageInput = getEl('events-per-page'),
            showTimestampCheckbox = getEl('show-timestamp'), showUrlCheckbox = getEl('show-url'),
            customGradientControls = getEl('custom-gradient-controls'), gradientStartColorInput = getEl('gradient-start-color'), gradientEndColorInput = getEl('gradient-end-color'),
            downloadBtn = getEl('download-btn'), clearBtn = getEl('clear-btn'), sortBtn = getEl('sort-btn'), exportBtn = getEl('export-btn'),
            exportWithImageCheckbox = getEl('export-with-image'),
            importBtn = getEl('import-btn'), importInput = getEl('import-input'), backgroundImageInput = getEl('background-image-input'),
            uploadImageBtn = getEl('upload-image-btn'), removeImageBtn = getEl('remove-image-btn'), loadingIndicator = getEl('loading-indicator'), statusMessage = getEl('status-message'),
            gSheetUrlInput = getEl('g-sheet-url'), fetchGSheetBtn = getEl('fetch-g-sheet'),
            posterContent = getEl('poster-content'), posterBackgroundImage = getEl('poster-background-image'), posterBackgroundOverlay = getEl('poster-background-overlay'),
            previewTitle = getEl('preview-title'), previewSubtitle = getEl('preview-subtitle'), previewListContainer = document.querySelector('#poster-content .event-list-container'),
            previewTimestamp = getEl('preview-timestamp'), previewFooter = getEl('preview-footer'), previewUrl = getEl('preview-url'),
            modal = getEl('custom-modal'), modalTitle = getEl('modal-title'), modalMessage = getEl('modal-message'), modalButtons = getEl('modal-buttons'),
            textStyleCategorySelect = getEl('text-style-category'), fontFamilySelect = getEl('font-family'), textColorInput = getEl('text-color'),
            fontSizeInput = getEl('font-size-input'), fontWeightInput = getEl('font-weight-input'), strokeColorInput = getEl('stroke-color'),
            strokeWidthInput = getEl('stroke-width-input'), shadowColorInput = getEl('shadow-color'), shadowBlurInput = getEl('shadow-blur-input'),
            shadowOffsetXInput = getEl('shadow-offset-x-input'), shadowOffsetYInput = getEl('shadow-offset-y-input'),
            imageBackgroundControls = getEl('image-background-controls'),
            backgroundBlurSlider = getEl('background-blur-slider'), overlayTypeSelect = getEl('overlay-type'),
            overlayControls = getEl('overlay-controls'), overlaySolidControls = getEl('overlay-solid-controls'),
            overlayGradientControls = getEl('overlay-gradient-controls'), overlayColorInput = getEl('overlay-color'),
            overlayGradientStartInput = getEl('overlay-gradient-start'), overlayGradientEndInput = getEl('overlay-gradient-end'),
            overlayGradientDirectionSlider = getEl('overlay-gradient-direction'), overlayOpacitySlider = getEl('overlay-opacity-slider'),
            autoPaginateCheckbox = getEl('auto-paginate'), autoShortenLocationCheckbox = getEl('auto-shorten-location');

        // --- DATA STATE ---
        let datepickerInstance, currentImageObjectUrl = null, events = [], settings = {};
        const createDefaultStyle = (o={})=>({...{fontFamily:"'Inter',sans-serif",fontSize:32,fontWeight:400,color:"#E5E7EB",strokeColor:"#000000",strokeWidth:0,shadowColor:"#000000",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0},...o});
        const defaultTextStyles={title:createDefaultStyle({fontSize:82,fontWeight:900,color:"#FFFFFF"}),subtitle:createDefaultStyle({fontSize:52,fontWeight:500,color:"#9CA3AF"}),eventName:createDefaultStyle({fontSize:52,fontWeight:700,color:"#FFFFFF"}),eventDetails:createDefaultStyle({fontSize:32,fontWeight:400,color:"#D1D5DB"}),price:createDefaultStyle({fontSize:40,fontWeight:700,color:"#67E8F9"}),priceFree:createDefaultStyle({fontSize:40,fontWeight:700,color:"#6EE7B7"}),priceTba:createDefaultStyle({fontSize:40,fontWeight:700,color:"#FCD34D"}),footer:createDefaultStyle({fontSize:24,fontWeight:400,color:"#6B7280"}),timestamp:createDefaultStyle({fontSize:20,fontWeight:400,color:"#6B7280"}),url:createDefaultStyle({fontSize:18,fontWeight:400,color:"#4B5563"})};
        const defaultSettings={theme:"sekai",title:"UPCOMING EVENT",subtitle:"List on Bandung",background:"deep-space",footer:"Made by Wibu_Baleendah",eventsPerPage:9,autoPaginate:!1,autoShortenLocation:!1,showTimestamp:!0,showUrl:!1,posterSize:"1080x1920",gSheetUrl:"https://docs.google.com/spreadsheets/d/e/2PACX-1vTGyL52upswhocSjN6JDulVRYjzMjXCT6VLnvD373OhjDCOgRRuFpSE0YpP0-oQp32bda58xBOCCZEJ/pub?gid=1358508738&single=true&output=csv",customGradient:{start:"#1f2937",end:"#111827"},backgroundImage:null,backgroundBlur:0,overlayType:"none",overlayColor:"#000000",overlayOpacity:0.5,overlayGradient:{start:"#000000",end:"#ffffff",direction:45},textStyles:JSON.parse(JSON.stringify(defaultTextStyles))};
        const defaultEvents = [
            { "name": "Nihon no Matsuri 16", "date": "21/06/2025", "location": "Telkom University, Bandung", "socialMedia": "@nihonnomatsuri", "priceText": "Rp 25.000", "isFree": false },
            { "name": "Bunka no Hi", "date": "28/06/2025", "location": "Cihampelas Walk, Bandung", "socialMedia": "@bunkanohi_", "priceText": "Free", "isFree": true },
        ];
        const textStyleCategories={title:{label:"Title",elements:()=>[previewTitle]},subtitle:{label:"Subtitle",elements:()=>[previewSubtitle]},eventName:{label:"Event Name",elements:()=>document.querySelectorAll(".event-item-name")},eventDetails:{label:"Event Details (Date, Loc)",elements:()=>document.querySelectorAll(".event-item-details-text")},price:{label:"Ticket Price (Default)",elements:()=>document.querySelectorAll('.event-item-price[data-price-type="default"]')},priceFree:{label:"Ticket Price (Free)",elements:()=>document.querySelectorAll('.event-item-price[data-price-type="free"]')},priceTba:{label:"Ticket Price (TBA)",elements:()=>document.querySelectorAll('.event-item-price[data-price-type="tba"]')},footer:{label:"Footer",elements:()=>[previewFooter]},timestamp:{label:"Timestamp",elements:()=>[previewTimestamp]},url:{label:"URL",elements:()=>[previewUrl]}};
        const availableFonts={
            "'Inter', sans-serif": "Inter", "'Roboto', sans-serif": "Roboto", "'Lato', sans-serif": "Lato", "'Montserrat', sans-serif": "Montserrat",
            "'Oswald', sans-serif": "Oswald", "'Playfair Display', serif": "Playfair Display", "'Lora', serif": "Lora", "'Merriweather', serif": "Merriweather",
            "'Lobster', cursive": "Lobster", "'Pacifico', cursive": "Pacifico", "'Roboto Mono', monospace": "Roboto Mono", "'Source Code Pro', monospace": "Source Code Pro"
        };
        const gradients={ 'deep-space': 'linear-gradient(to bottom right, #1f2937, #111827)', 'sunset': 'linear-gradient(to bottom right, #7b2cbf, #f97316)', 'oceanic': 'linear-gradient(to bottom right, #0369a1, #10b981)', 'minty': 'linear-gradient(to bottom right, #6ee7b7, #3b82f6)', 'royal': 'linear-gradient(to bottom right, #7e22ce, #db2777)', 'gotham': 'linear-gradient(to bottom right, #404040, #0a0a0a)'};

        // --- UTILS & MODALS ---
        function debounce(func,delay=CONFIG.DEBOUNCE_DELAY){let t;return(...e)=>{clearTimeout(t),t=setTimeout(()=>func.apply(this,e),delay)}}
        let statusTimeout;
        function showStatusMessage(e,t=!1){clearTimeout(statusTimeout),statusMessage.textContent=e,statusMessage.style.color=t?"var(--ui-error)":"#4ade80",statusMessage.classList.add("visible"),statusTimeout=setTimeout(()=>{statusMessage.classList.remove("visible")},CONFIG.STATUS_MESSAGE_DURATION)}
        function showAlert(e,t){modalTitle.textContent=e,modalMessage.textContent=t,modalButtons.innerHTML='<button id="modal-ok" class="ui-btn ui-btn-filled">OK</button>',modal.classList.remove("hidden"),setTimeout(()=>modal.firstElementChild.classList.remove("scale-95"),10),getEl("modal-ok").onclick=()=>{modal.firstElementChild.classList.add("scale-95"),setTimeout(()=>modal.classList.add("hidden"),300)}}
        function showConfirm(e,t,n){modalTitle.textContent=e,modalMessage.textContent=t,modalButtons.innerHTML='<button id="modal-cancel" class="ui-btn ui-btn-outlined">Cancel</button><button id="modal-confirm" class="ui-btn ui-btn-danger">Confirm</button>',modal.classList.remove("hidden"),setTimeout(()=>modal.firstElementChild.classList.remove("scale-95"),10);const o=()=>{modal.firstElementChild.classList.add("scale-95"),setTimeout(()=>modal.classList.add("hidden"),300)};getEl("modal-cancel").onclick=o,getEl("modal-confirm").onclick=()=>{o(),n()}}

        // --- DATA & STATE ---
        const saveState=async()=>{try{await idb.set("appState",{events,settings}),showStatusMessage("Changes saved!")}catch(e){console.error("Error saving state:",e),showAlert("Save Error","Could not save your changes.")}},debouncedSaveState=debounce(saveState,500);
        const loadState = async () => {
            try {
                const loadedState = await idb.get('appState');
                settings = JSON.parse(JSON.stringify(defaultSettings));
                if (!loadedState || typeof loadedState !== 'object' || !loadedState.events || !loadedState.settings) {
                    throw new Error("No valid state found in DB.");
                }
                
                events = loadedState.events;
                
                for (const key in loadedState.settings) {
                    if (Object.prototype.hasOwnProperty.call(loadedState.settings, key) && key !== 'textStyles' && key !== 'customGradient' && key !== 'overlayGradient') {
                        settings[key] = loadedState.settings[key];
                    }
                }
                 if (loadedState.settings.textStyles) {
                    for (const key in defaultTextStyles) {
                        settings.textStyles[key] = { ...defaultTextStyles[key], ...loadedState.settings.textStyles[key] };
                    }
                }
                 if (loadedState.settings.customGradient) {
                    settings.customGradient = { ...defaultSettings.customGradient, ...loadedState.settings.customGradient };
                }
                 if (loadedState.settings.overlayGradient) {
                    settings.overlayGradient = { ...defaultSettings.overlayGradient, ...loadedState.settings.overlayGradient };
                }

                if (settings.backgroundImage instanceof Blob) {
                    if (currentImageObjectUrl) URL.revokeObjectURL(currentImageObjectUrl);
                    currentImageObjectUrl = URL.createObjectURL(settings.backgroundImage);
                }
            } catch (error) {
                console.warn("Could not load state, using defaults.", error);
                events = JSON.parse(JSON.stringify(defaultEvents));
                settings = JSON.parse(JSON.stringify(defaultSettings));
            }
        };
        
        // --- RENDERING ---
        function updatePreviewSize(){const e=getEl("preview-wrapper"),t=getEl("poster-scaler");if(!e||!t){return}const[n,o]=settings.posterSize.split("x").map(Number);e.style.aspectRatio=`${n} / ${o}`;const s=e.offsetWidth/n;t.style.transform=`scale(${s})`}
        function applyStylesToElement(e,t){e&&t&&(e.style.fontFamily=t.fontFamily,e.style.fontSize=`${t.fontSize}px`,e.style.fontWeight=t.fontWeight,e.style.color=t.color,e.style.webkitTextStroke=`${t.strokeWidth}px ${t.strokeColor}`,e.style.textShadow=`${t.shadowOffsetX}px ${t.shadowOffsetY}px ${t.shadowBlur}px ${t.shadowColor}`)}
        function updateAllTextStyles(){Object.keys(textStyleCategories).forEach(e=>{const t=textStyleCategories[e].elements(),n=settings.textStyles[e];t.forEach(t=>applyStylesToElement(t,n))})}
        function createEventElement(e,t,n){const o=document.createElement("div");o.className="flex items-center gap-4";const s=document.createElement("div");s.className="event-item py-4 border-b border-white/20 flex-grow";let a="price",l="default";e.isFree?(a="priceFree",l="free"):!e.priceText||"TBA"!==e.priceText.toUpperCase()||(a="priceTba",l="tba");let r=e.location;settings.autoShortenLocation&&r.length>40&&(r=r.substring(0,37)+"...");const i=n?`\n                <div class="action-buttons flex flex-col gap-2 z-30">\n                    <button data-action="remove" data-index="${t}" title="Remove Event" class="text-gray-400 hover:text-red-500 transition-colors">\n                        <svg class="w-8 h-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>\n                    </button>\n                </div>\n                `:"";return s.innerHTML=`\n                <div class="flex justify-between items-start gap-4">\n                    <h3 class="event-item-name break-words min-w-0" contenteditable="true" data-index="${t}" data-field="name">${e.name}</h3>\n                    <p class="event-item-price flex-shrink-0 pl-4" data-price-type="${l}" contenteditable="true" data-index="${t}" data-field="priceText">${e.priceText}</p>\n                </div>\n                <div class="mt-4">\n                    <div class="flex flex-wrap items-center gap-x-4">\n                        <span class="event-item-details-text" contenteditable="true" data-index="${t}" data-field="date">${e.date}</span>\n                        <span class="event-item-details-text text-gray-500">|</span>\n                        <span class="event-item-details-text" contenteditable="true" data-index="${t}" data-field="location" data-original-location="${e.location}">${r}</span>\n                        ${e.socialMedia?`<span class="event-item-details-text text-gray-500">|</span><span class="event-item-details-text" contenteditable="true" data-index="${t}" data-field="socialMedia">${e.socialMedia}</span>`:""}\n                    </div>\n                </div>\n            `,applyStylesToElement(s.querySelector(".event-item-name"),settings.textStyles.eventName),s.querySelectorAll(".event-item-details-text").forEach(e=>applyStylesToElement(e,settings.textStyles.eventDetails)),applyStylesToElement(s.querySelector(".event-item-price"),settings.textStyles[a]),o.appendChild(s),n&&(()=>{const e=document.createElement("div");e.innerHTML=i,o.appendChild(e)})(),o}
        const renderEventsInPreview=()=>{previewListContainer.innerHTML="",0===events.length?previewListContainer.innerHTML='<div class="p-8 text-center text-gray-500"><h3 class="text-4xl font-bold">No events yet.</h3><p class="text-3xl mt-2">Use the form to add one!</p></div>':(events.forEach((e,t)=>{const n=createEventElement(e,t,!0);previewListContainer.appendChild(n)}),updateAllTextStyles())};
        function updateFormControls(){posterSizeSelect.value=settings.posterSize,posterTitleInput.value=settings.title,posterSubtitleInput.value=settings.subtitle,posterBackgroundSelect.value=settings.background,posterFooterInput.value=settings.footer,eventsPerPageInput.value=settings.eventsPerPage,eventsPerPageContainer.style.display=settings.autoPaginate?"none":"block",autoPaginateCheckbox.checked=settings.autoPaginate,autoShortenLocationCheckbox.checked=settings.autoShortenLocation,showTimestampCheckbox.checked=settings.showTimestamp,showUrlCheckbox.checked=settings.showUrl,gSheetUrlInput.value=settings.gSheetUrl,gradientStartColorInput.value=settings.customGradient.start,gradientEndColorInput.value=settings.customGradient.end,backgroundBlurSlider.value=settings.backgroundBlur,overlayTypeSelect.value=settings.overlayType,overlayColorInput.value=settings.overlayColor,overlayGradientStartInput.value=settings.overlayGradient.start,overlayGradientEndInput.value=settings.overlayGradient.end,overlayGradientDirectionSlider.value=settings.overlayGradient.direction,overlayOpacitySlider.value=settings.overlayOpacity,textStyleCategorySelect.innerHTML=Object.keys(textStyleCategories).map(e=>`<option value="${e}">${textStyleCategories[e].label}</option>`).join(""),fontFamilySelect.innerHTML=Object.keys(availableFonts).map(e=>`<option value="${e}">${availableFonts[e]}</option>`).join(""),populateTextStyleEditor()}
        function updatePosterLook(){"1080x1350"===settings.posterSize?(posterContent.classList.remove("size-story"),posterContent.classList.add("size-post")):(posterContent.classList.remove("size-post"),posterContent.classList.add("size-story"));updatePreviewSize(),previewTitle.textContent=settings.title,previewSubtitle.textContent=settings.subtitle,previewFooter.textContent=settings.footer,customGradientControls.classList.toggle("hidden","custom-gradient"!==settings.background),imageBackgroundControls.classList.toggle("hidden","image"!==settings.background),posterBackgroundImage.style.filter=`blur(${settings.backgroundBlur}px)`,"image"===settings.background?(posterBackgroundImage.style.backgroundImage=currentImageObjectUrl?`url(${currentImageObjectUrl})`:"none",updateOverlay()):(posterBackgroundImage.style.backgroundImage="none",posterBackgroundImage.style.filter="none",posterBackgroundOverlay.style.backgroundImage="custom-gradient"===settings.background?`linear-gradient(to bottom right, ${settings.customGradient.start}, ${settings.customGradient.end})`:gradients[settings.background],posterBackgroundOverlay.style.backgroundColor="transparent",posterBackgroundOverlay.style.opacity=1),previewTimestamp.style.display="none",previewUrl.style.display="none",updateAllTextStyles()}
        function updateOverlay(){const e=posterBackgroundOverlay;if("image"!==settings.background||"none"===settings.overlayType)return e.style.backgroundImage="none",void(e.style.opacity=0);e.style.opacity=settings.overlayOpacity;"solid"===settings.overlayType?e.style.backgroundImage=`linear-gradient(${settings.overlayColor}, ${settings.overlayColor})`:"gradient"===settings.overlayType&&(e.style.backgroundImage=`linear-gradient(${settings.overlayGradient.direction}deg, ${settings.overlayGradient.start}, ${settings.overlayGradient.end})`)}
        
        // --- LOGIC ---
        const formatPrice=e=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(e);
        const parseDate=e=>{if(!e||"TBA"===e.toUpperCase())return null;const t=e.split("/");if(3!==t.length)return null;const[n,o,s]=t.map(Number);return isNaN(n)||isNaN(o)||isNaN(s)?null:new Date(s,o-1,n)};
        const sortEvents=()=>events.sort((e,t)=>{const n=parseDate(e.date),o=parseDate(t.date);return null===n&&null===o?0:null===n?1:null===o?-1:n-o});
        async function addEvent(e){e.preventDefault();let t;isFreeCheckbox.checked?t="Free":isTbaCheckbox.checked?t="TBA":t=""===eventPriceInput.value.trim()?"TBA":formatPrice(parseFloat(eventPriceInput.value));const n={name:eventNameInput.value,date:isDateTbaCheckbox.checked?"TBA":eventDateInput.value,location:eventLocationInput.value,socialMedia:eventSocialInput.value,priceText:t,isFree:isFreeCheckbox.checked};events.push(n),sortEvents(),await saveState(),renderEventsInPreview(),eventForm.reset(),togglePriceInput(),toggleDateInput()}
        function handleListInteraction(e){const t=e.target.closest('button[data-action]');if(t){const n=t.dataset.action,o=parseInt(t.dataset.index,10);"remove"===n&&(events.splice(o,1),saveState(),renderEventsInPreview())}}
        function clearAllEvents(){0!==events.length&&showConfirm("Clear All Events","Are you sure you want to delete all events? This action cannot be undone.",async()=>{events=[],await saveState(),renderEventsInPreview()})}
        function togglePriceInput(e=null){"free"===e&&isFreeCheckbox.checked?(isTbaCheckbox.checked=!1,eventPriceInput.disabled=!0,eventPriceInput.value=""):"tba"===e&&isTbaCheckbox.checked?(isFreeCheckbox.checked=!1,eventPriceInput.disabled=!0,eventPriceInput.value=""):"input"===e?(isFreeCheckbox.checked=!1,isTbaCheckbox.checked=!1,eventPriceInput.disabled=!1):isFreeCheckbox.checked||isTbaCheckbox.checked||(eventPriceInput.disabled=!1)}
        function toggleDateInput(){isDateTbaCheckbox.checked?(eventDateInput.disabled=!0,eventDateInput.value="TBA",datepickerInstance&&datepickerInstance.hide()):(eventDateInput.disabled=!1,eventDateInput.value="")}

        // --- DATA I/O ---
        async function exportData() {
            if (events.length === 0) return showAlert('Cannot Export', 'There are no events to export.');
            const includeImage = exportWithImageCheckbox.checked;
            let exportableSettings = JSON.parse(JSON.stringify(settings));
            if (includeImage && settings.backgroundImage instanceof Blob) {
                exportableSettings.backgroundImage = await (e => new Promise((t, n) => {
                    const o = new FileReader; o.readAsDataURL(e); o.onload = () => t(o.result); o.onerror = e => n(e)
                }))(settings.backgroundImage);
            } else {
                exportableSettings.backgroundImage = null;
            }
            const dataStr = JSON.stringify({ events, settings: exportableSettings }, null, 2);
            const dataBlob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.download = `event-poster-data-${new Date().toISOString().slice(0, 10)}.json`;
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        async function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    let importedEvents = null;
                    if (file.name.toLowerCase().endsWith(".json")) {
                        const importedState = JSON.parse(e.target.result);
                        if (importedState && importedState.settings) {
                            importedEvents = importedState.events || [];
                            settings = { ...defaultSettings, ...importedState.settings };
                            if (typeof settings.backgroundImage === 'string' && settings.backgroundImage.startsWith('data:image')) {
                                settings.backgroundImage = await (await fetch(settings.backgroundImage)).blob();
                            }
                        } else { showAlert('Import Error', 'Invalid JSON file format.'); }
                    } else if (file.name.toLowerCase().endsWith(".csv")) {
                        await new Promise((resolve, reject) => {
                            findAndProcessCsv(e.target.result, (results) => {
                                const parsed = parseCsvData(results);
                                if (parsed) { importedEvents = parsed; resolve(); }
                                else { reject(new Error("CSV parsing failed.")); }
                            });
                        });
                    }
                    if (importedEvents !== null) {
                        events = importedEvents; sortEvents(); await saveState(); await loadState();
                        updateFormControls(); updatePosterLook(); renderEventsInPreview();
                        showStatusMessage('Data imported successfully!');
                    }
                } catch (error) { console.error("Error parsing file:", error); showAlert('Import Error', 'Could not read file.'); }
            };
            reader.readAsText(file);
            importInput.value = '';
        }
        function findAndProcessCsv(e,t){const n=e.split("\n");let o=-1;const s=["name","date"],a=["tanggal","event"];for(let l=0;l<n.length;l++){const r=n[l].toLowerCase().trim(),i=s.every(e=>r.includes(e)),c=a.every(e=>r.includes(e));if(i||c){o=l;break}}-1===o?(showAlert("CSV Error",'Could not find a valid header row. Please ensure columns like "name", "date" or "Tanggal", "Event" exist.'),t({data:[],errors:[{message:"Header not found"}]})):Papa.parse(n.slice(o).join("\n"),{header:!0,skipEmptyLines:!0,complete:t})}
        function parseCsvData(e){if(e.errors.length>0&&e.errors.some(e=>"TooManyFields"!==e.code&&"TooFewFields"!==e.code))return console.error("CSV Parsing Errors:",e.errors),showAlert("Parsing Error","Could not parse the CSV data. Please check the file format."),null;const t=e.meta.fields.map(e=>e.trim().toLowerCase()),n=["name","date","location","socialmedia","pricetext","isfree"],o=["tanggal","event","lokasi","ticket","link event"],s=n.every(e=>t.includes(e)),a=o.every(e=>t.includes(e));if(!s&&!a){const l=n.filter(e=>!t.includes(e)),r=o.filter(e=>!t.includes(e));let i="The CSV is missing required columns. ";return i+=l.length<r.length?`Standard format is missing: ${l.join(", ")}.`:`Custom format is missing: ${r.join(", ")}.`,showAlert("Incorrect Columns",i),null}const l=a;return e.data.map(e=>{const t={};for(const n in e)t[n.trim().toLowerCase()]=e[n];if(l){const n={januari:"01",january:"01",februari:"02",february:"02",maret:"03",march:"03",april:"04",mei:"05",may:"05",juni:"06",june:"06",juli:"07",july:"07",agustus:"08",august:"08",september:"09",oktober:"10",october:"10",november:"11",desember:"12",december:"12"},o=(t.tanggal||"").trim();let s=o;if("TBA"!==o.toUpperCase()&&o){const a=o.split(" ");3===a.length&&(()=>{const l=a[0].padStart(2,"0"),r=n[a[1].toLowerCase()],i=a[2];l&&r&&i&&(s=`${l}/${r}/${i}`)})()}else s="TBA";let a=(t.ticket||"").trim(),r=!1;const i=a.toUpperCase();if("FREE"===i)r=!0;else if("TBA"!==i)if(i.includes("-")){const c=i.split("-")[0].trim(),d=1e3*parseFloat(c.replace("K",""));isNaN(d)||(a=formatPrice(d)+"+")}else i.endsWith("K")?(()=>{const u=1e3*parseFloat(i.replace("K",""));isNaN(u)||(a=formatPrice(u))})():isNaN(parseFloat(a))||(a=formatPrice(parseFloat(a)));const c=(t["link event"]||"").trim();let d=c;if(c)try{const p=new URL(c),m=p.pathname.split("/").filter(Boolean);d=m.pop()||""}catch(e){}return d&&!d.startsWith("@")&&(d="@"+d),{name:t.event||"",date:s,location:t.lokasi||"",socialMedia:d,priceText:a,isFree:r}}return{name:t.name||"",date:t.date||"",location:t.location||"",socialMedia:t.socialmedia||"",priceText:t.pricetext||"",isFree:"TRUE"===String(t.isfree).toUpperCase()}})}
        
        // --- DIRECT EDIT & STYLE ---
        const settingToInputMap={title:posterTitleInput,subtitle:posterSubtitleInput,footer:posterFooterInput};
        function handleDirectEdit(e){const t=e.target;if(t&&t.isContentEditable){const n=t.dataset.setting;if(n){const o=t.textContent.trim();settings[n]!==o&&(settings[n]=o,settingToInputMap[n].value=o,debouncedSaveState())}else if(t.dataset.field){const s=parseInt(t.dataset.index,10),a=t.dataset.field,l=t.textContent.trim();if(events[s])if("priceText"===a){const r=l.toUpperCase();let i;"FREE"===r?(i="Free",events[s].isFree=!0):"TBA"===r?(i="TBA",events[s].isFree=!1):(()=>{const c=parseFloat(l.replace(/[^0-9]/g,""));isNaN(c)?(i="TBA",events[s].isFree=!1):(i=formatPrice(c),events[s].isFree=!1)})();events[s].priceText!==i&&(events[s].priceText=i,debouncedSaveState(),renderEventsInPreview())}else"date"===a?events[s][a]!==l&&(events[s][a]=l,sortEvents(),debouncedSaveState(),renderEventsInPreview()):events[s][a]!==l&&(events[s][a]=l,debouncedSaveState())}}}
        function preventLineBreaks(e){e.target.isContentEditable&&"Enter"===e.key&&(e.preventDefault(),e.target.blur())}
        async function getProcessedImage(){if(!(settings.backgroundImage instanceof Blob))return null;if(0===settings.backgroundBlur)return currentImageObjectUrl;const e=await createImageBitmap(settings.backgroundImage),t=document.createElement("canvas");t.width=e.width,t.height=e.height;const n=t.getContext("2d");return n.filter=`blur(${settings.backgroundBlur}px)`,n.drawImage(e,0,0),t.toDataURL()}
        async function downloadImage(){if(0===events.length)return void showAlert("Cannot Download","Please add at least one event before downloading.");loadingIndicator.classList.remove("hidden"),downloadBtn.disabled=!0;const e=e=>new Promise(t=>setTimeout(t,e)),[t,n]=settings.posterSize.split("x").map(Number);let o=[];if(settings.autoPaginate){loadingIndicator.textContent="Calculating page layout...",await e(50);const s=posterContent.cloneNode(!0);s.style.position="absolute",s.style.left="-9999px",s.style.visibility="hidden",document.body.appendChild(s);const a=s.querySelector(".event-list-container"),l=a.clientHeight;let r=[...events];for(;r.length>0;){let i=[],c=0;for(a.innerHTML="";c<r.length;c++){const d=r[c],p=createEventElement(d,c,!1);if(a.appendChild(p),a.scrollHeight>l){0===i.length&&i.push(d);break}i.push(d)}o.push(i),r.splice(0,i.length)}document.body.removeChild(s)}else{const u=parseInt(eventsPerPageInput.value,10)||9;for(let m=0;m<events.length;m+=u)o.push(events.slice(m,m+u))}let h=null;if("image"===settings.background&&settings.backgroundImage&&(loadingIndicator.textContent="Processing background...",h=await getProcessedImage()),o.length>0)for(let g=0;g<o.length;g++){const f=g+1;loadingIndicator.textContent=`Generating image ${f} of ${o.length}...`;const y=o[g],v=posterContent.cloneNode(!0);v.querySelectorAll('[contenteditable="true"]').forEach(e=>e.setAttribute("contenteditable","false"));const E=v.querySelector("#poster-background-image");E.style.filter="none",h&&(E.style.backgroundImage=`url(${h})`);const S=v.querySelector(".event-list-container");S.innerHTML="",y.forEach((e,t)=>{const n=createEventElement(e,t,!1);S.appendChild(n)});const b=v.querySelector("#preview-timestamp");settings.showTimestamp?(b.textContent=`Generated on: ${(new Date).toLocaleString()}`,b.style.display="block"):(b.style.display="none");const L=v.querySelector("#preview-url");settings.showUrl?(L.textContent=window.location.href,L.style.display="block"):(L.style.display="none"),v.style.position="absolute",v.style.top="-9999px",document.body.appendChild(v);try{await e(200);const C=await html2canvas(v,{scale:1,useCORS:!0,logging:!1,backgroundColor:null,width:t,height:n,windowWidth:t,windowHeight:n}),A=document.createElement("a");A.download=`event-poster-${f}.png`,A.href=C.toDataURL("image/png"),A.click(),A.remove(),await e(500)}catch(k){console.error("Image generation failed:",k),showAlert("Image Generation Failed",`An error on image ${f}.`);break}finally{document.body.removeChild(v)}}loadingIndicator.classList.add("hidden"),loadingIndicator.textContent="Generating...",downloadBtn.disabled=!1}
        function populateTextStyleEditor(){const e=textStyleCategorySelect.value,t=settings.textStyles[e];t&&(fontFamilySelect.value=t.fontFamily,textColorInput.value=t.color,fontSizeInput.value=t.fontSize,fontWeightInput.value=t.fontWeight,strokeColorInput.value=t.strokeColor,strokeWidthInput.value=t.strokeWidth.toFixed(1),shadowColorInput.value=t.shadowColor,shadowBlurInput.value=t.shadowBlur,shadowOffsetXInput.value=t.shadowOffsetX,shadowOffsetYInput.value=t.shadowOffsetY)}
        function handleTextStyleChange(e,t){const n=textStyleCategorySelect.value;settings.textStyles[n][e]=t,updatePosterLook(),debouncedSaveState()}
        
        // --- INIT & LISTENERS ---
        async function init(){
            await loadState();
            datepickerInstance=new Datepicker(eventDateInput,{format:"dd/mm/yyyy",autohide:!0,buttonClass:"btn"});
            updateFormControls();
            updatePosterLook();
            renderEventsInPreview();
            attachListeners();
        }
        function attachListeners(){
            window.addEventListener("resize",debounce(updatePreviewSize,100));
            
            posterSizeSelect.addEventListener("change",async e=>(settings.posterSize=e.target.value,updateFormControls(),updatePosterLook(),await saveState()));
            posterTitleInput.addEventListener("input",e=>{settings.title=e.target.value,previewTitle.textContent=e.target.value,debouncedSaveState()});
            posterSubtitleInput.addEventListener("input",e=>{settings.subtitle=e.target.value,previewSubtitle.textContent=e.target.value,debouncedSaveState()});
            posterBackgroundSelect.addEventListener("change", e => {
                settings.background = e.target.value;
                updatePosterLook();
                const accordionContent = imageBackgroundControls.closest('.accordion-content');
                if (accordionContent && accordionContent.style.maxHeight && accordionContent.style.maxHeight !== '0px') {
                    setTimeout(() => { accordionContent.style.maxHeight = accordionContent.scrollHeight + "px"; }, 50);
                }
                saveState();
            });
            posterFooterInput.addEventListener("input",e=>{settings.footer=e.target.value,previewFooter.textContent=e.target.value,debouncedSaveState()});
            eventsPerPageInput.addEventListener("input",e=>{settings.eventsPerPage=parseInt(e.target.value,10),saveState()});
            showTimestampCheckbox.addEventListener("change",e=>{settings.showTimestamp=e.target.checked,saveState()});
            showUrlCheckbox.addEventListener("change",e=>{settings.showUrl=e.target.checked,saveState()});
            autoPaginateCheckbox.addEventListener("change",e=>{settings.autoPaginate=e.target.checked,eventsPerPageContainer.style.display=settings.autoPaginate?"none":"block",saveState()});
            autoShortenLocationCheckbox.addEventListener("change",e=>{settings.autoShortenLocation=e.target.checked,renderEventsInPreview(),saveState()});
            
            gradientStartColorInput.addEventListener("input",debounce(e=>{settings.customGradient.start=e.target.value,updatePosterLook(),saveState()}));
            gradientEndColorInput.addEventListener("input",debounce(e=>{settings.customGradient.end=e.target.value,updatePosterLook(),saveState()}));
            
            uploadImageBtn.addEventListener("click",()=>backgroundImageInput.click());
            removeImageBtn.addEventListener('click', () => {
                if (currentImageObjectUrl) URL.revokeObjectURL(currentImageObjectUrl);
                currentImageObjectUrl = null;
                settings.backgroundImage = null;
                updatePosterLook();
                saveState();
            });
            backgroundImageInput.addEventListener("change",e=>{const t=e.target.files[0];t&&(currentImageObjectUrl&&URL.revokeObjectURL(currentImageObjectUrl),settings.backgroundImage=t,currentImageObjectUrl=URL.createObjectURL(t),updatePosterLook(),saveState(),backgroundImageInput.value="")});
            
            backgroundBlurSlider.addEventListener('input', debounce(e => { settings.backgroundBlur = e.target.value; updatePosterLook(); saveState(); }));
            overlayTypeSelect.addEventListener('change', e => {
                settings.overlayType = e.target.value;
                overlayControls.classList.toggle('hidden', e.target.value === 'none');
                overlaySolidControls.classList.toggle('hidden', e.target.value !== 'solid');
                overlayGradientControls.classList.toggle('hidden', e.target.value !== 'gradient');
                updatePosterLook();
                const accordionContent = overlayControls.closest('.accordion-content');
                 if (accordionContent && accordionContent.style.maxHeight && accordionContent.style.maxHeight !== '0px') {
                    setTimeout(() => { accordionContent.style.maxHeight = accordionContent.scrollHeight + "px"; }, 50);
                }
                saveState();
            });
            overlayColorInput.addEventListener('input', debounce(e => { settings.overlayColor = e.target.value; updatePosterLook(); saveState(); }));
            overlayGradientStartInput.addEventListener('input', debounce(e => { settings.overlayGradient.start = e.target.value; updatePosterLook(); saveState(); }));
            overlayGradientEndInput.addEventListener('input', debounce(e => { settings.overlayGradient.end = e.target.value; updatePosterLook(); saveState(); }));
            overlayGradientDirectionSlider.addEventListener('input', debounce(e => { settings.overlayGradient.direction = e.target.value; updatePosterLook(); saveState(); }));
            overlayOpacitySlider.addEventListener('input', debounce(e => { settings.overlayOpacity = e.target.value; updatePosterLook(); saveState(); }));

            posterContent.addEventListener("focusout",handleDirectEdit);
            posterContent.addEventListener("keydown",preventLineBreaks);
            eventForm.addEventListener("submit",addEvent);
            isFreeCheckbox.addEventListener("change",()=>togglePriceInput("free"));
            isTbaCheckbox.addEventListener("change",()=>togglePriceInput("tba"));
            eventPriceInput.addEventListener("input",()=>togglePriceInput("input"));
            isDateTbaCheckbox.addEventListener("change",toggleDateInput);
            downloadBtn.addEventListener("click",downloadImage);
            clearBtn.addEventListener("click",clearAllEvents);
            sortBtn.addEventListener("click",async()=>{sortEvents(),await saveState(),renderEventsInPreview()});
            previewListContainer.addEventListener("click",handleListInteraction);
            exportBtn.addEventListener("click",exportData);
            importBtn.addEventListener("click",()=>importInput.click());
            importInput.addEventListener("change",importData);
            
            textStyleCategorySelect.addEventListener("change",populateTextStyleEditor);
            fontFamilySelect.addEventListener("change",e=>handleTextStyleChange("fontFamily",e.target.value));
            textColorInput.addEventListener("input",debounce(e=>handleTextStyleChange("color",e.target.value)));
            fontSizeInput.addEventListener("input",debounce(e=>handleTextStyleChange("fontSize",parseInt(e.target.value,10))));
            fontWeightInput.addEventListener("input",debounce(e=>handleTextStyleChange("fontWeight",parseInt(e.target.value,10))));
            strokeColorInput.addEventListener("input",debounce(e=>handleTextStyleChange("strokeColor",e.target.value)));
            strokeWidthInput.addEventListener("input",debounce(e=>handleTextStyleChange("strokeWidth",parseFloat(e.target.value))));
            shadowColorInput.addEventListener("input",debounce(e=>handleTextStyleChange("shadowColor",e.target.value)));
            shadowBlurInput.addEventListener("input",debounce(e=>handleTextStyleChange("shadowBlur",parseInt(e.target.value,10))));
            shadowOffsetXInput.addEventListener("input",debounce(e=>handleTextStyleChange("shadowOffsetX",parseInt(e.target.value,10))));
            shadowOffsetYInput.addEventListener("input",debounce(e=>handleTextStyleChange("shadowOffsetY",parseInt(e.target.value,10))));


            getEl("controls-accordion").addEventListener("click",e=>{
                const n=e.target.closest(".accordion-header");
                if(n){
                    const o=n.nextElementSibling,s=n.querySelector("svg");
                    o.style.maxHeight?(o.style.maxHeight=null,s.style.transform="rotate(0deg)"):(o.style.maxHeight=o.scrollHeight+"px",s.style.transform="rotate(-180deg)")
                }
            });
            fetchGSheetBtn.addEventListener("click",async()=>{
                const e=gSheetUrlInput.value.trim();
                if(!e)return void showAlert("Invalid URL","Please enter a Google Sheet URL.");
                settings.gSheetUrl=e,await saveState(),showStatusMessage("Fetching data...");
                try{
                    const t=await fetch(e);
                    if(!t.ok)throw new Error(`Network response was not ok: ${t.statusText}`);
                    const n=await t.text();
                    findAndProcessCsv(n,async e=>{
                        const t=parseCsvData(e);
                        t&&(events=t,sortEvents(),await saveState(),renderEventsInPreview(),showStatusMessage("Data fetched successfully!"))
                    })
                }catch(o){
                    console.error("Error fetching Google Sheet:",o),showAlert("Fetch Error","Could not fetch data from the provided URL. Please ensure it is a valid, publicly published CSV link.")
                }
            });
        }
        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>
